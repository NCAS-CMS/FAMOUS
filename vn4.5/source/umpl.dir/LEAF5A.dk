*IF DEF,A03_5A                                                             LEAF5A.2     
C *****************************COPYRIGHT******************************     LEAF5A.3     
C (c) CROWN COPYRIGHT 1996, METEOROLOGICAL OFFICE, All Rights Reserved.    LEAF5A.4     
C                                                                          LEAF5A.5     
C Use, duplication or disclosure of this code is subject to the            LEAF5A.6     
C restrictions as set forth in the contract.                               LEAF5A.7     
C                                                                          LEAF5A.8     
C                Meteorological Office                                     LEAF5A.9     
C                London Road                                               LEAF5A.10    
C                BRACKNELL                                                 LEAF5A.11    
C                Berkshire UK                                              LEAF5A.12    
C                RG12 2SZ                                                  LEAF5A.13    
C                                                                          LEAF5A.14    
C If no contract has been raised with this copy of the code, the use,      LEAF5A.15    
C duplication or disclosure of it is strictly prohibited.  Permission      LEAF5A.16    
C to do so must first be obtained in writing from the Head of Numerical    LEAF5A.17    
C Modelling at the above address.                                          LEAF5A.18    
C ******************************COPYRIGHT******************************    LEAF5A.19    
C Calculates the leaf resistance and net photosynthesis using:             LEAF5A.20    
C  (i) Collatz et al. (1992) C3 photosynthesis model                       LEAF5A.21    
C (ii) Jacobs (1994) CI/CA closure.                                        LEAF5A.22    
C                                                                          LEAF5A.23    
C Written by Peter Cox (February 1996)                                     LEAF5A.24    
C**********************************************************************    LEAF5A.25    
      SUBROUTINE LEAF_C3 (LAND_PTS,LAND_INDEX,P1,P_POINTS                  LEAF5A.26    
     +,                   VEG_PTS,VEG_INDEX                                LEAF5A.27    
     +,                   FT,DQ,APAR,TL,CA,OA,PSTAR                        LEAF5A.28    
     +,                   NL0,FSMC                                         LEAF5A.29    
     +,                   GL,AL,CI,RD,LTIMER)                              LEAF5A.30    
                                                                           LEAF5A.31    
      IMPLICIT NONE                                                        LEAF5A.32    
                                                                           LEAF5A.33    
      INTEGER                                                              LEAF5A.34    
     + LAND_PTS                   ! IN Number of land points to be         LEAF5A.35    
C                                 !    processed.                          LEAF5A.36    
     +,LAND_INDEX(LAND_PTS)       ! IN Index of land points.               LEAF5A.37    
     +,P1                         ! IN First P point to be processed.      LEAF5A.38    
     +,P_POINTS                   ! IN Number of P points to be            LEAF5A.39    
C                                 !    processed.                          LEAF5A.40    
     +,VEG_PTS                    ! IN Number of vegetated points.         LEAF5A.41    
     +,VEG_INDEX(LAND_PTS)        ! IN Index of vegetated points           LEAF5A.42    
C                                 !    on the land grid.                   LEAF5A.43    
                                                                           LEAF5A.44    
      INTEGER                                                              LEAF5A.45    
     + FT(LAND_PTS)               ! IN Plant functional type.              LEAF5A.46    
                                                                           LEAF5A.47    
      REAL                                                                 LEAF5A.48    
     + DQ(LAND_PTS)               ! IN Canopy level specific humidity      LEAF5A.49    
C                                 !    deficit (kg H2O/kg air).            LEAF5A.50    
     +,APAR(LAND_PTS)             ! IN Absorbed PAR (W/m2)                 LEAF5A.51    
     +,TL(P_POINTS)               ! IN Leaf temperature (K).               LEAF5A.52    
     +,CA(LAND_PTS)               ! IN Canopy CO2 pressure (Pa).           LEAF5A.53    
     +,OA(LAND_PTS)               ! IN Atmospheric O2 pressure (Pa).       LEAF5A.54    
     +,PSTAR(P_POINTS)            ! IN Atmospheric pressure (Pa).          LEAF5A.55    
     +,NL0(LAND_PTS)              ! IN Leaf nitrogen conncentration        LEAF5A.56    
C                                 !    (kg N/kg C).                        LEAF5A.57    
     +,FSMC(LAND_PTS)             ! IN Soil water factor.                  LEAF5A.58    
     +,GL(LAND_PTS)               ! OUT Leaf conductance for H2O (m/s).    LEAF5A.59    
     +,AL(LAND_PTS)               ! OUT Net Leaf photosynthesis            LEAF5A.60    
C                                 !     (mol CO2/m2/s).                    LEAF5A.61    
     +,RD(LAND_PTS)               ! OUT Dark respiration (mol CO2/m2/s).   LEAF5A.62    
     +,CI(LAND_PTS)               ! OUT Internal CO2 pressure (Pa).        LEAF5A.63    
     +,ACR(LAND_PTS)              ! WORK Absorbed PAR                      LEAF5A.64    
C                                 !      (mol photons/m2/s).               LEAF5A.65    
     +,B1(LAND_PTS)               !                                        LEAF5A.66    
     +,B2(LAND_PTS)               !                                        LEAF5A.67    
     +,B3(LAND_PTS)               ! WORK Coefficients of the quadratic.    LEAF5A.68    
     +,CCP(LAND_PTS)              ! WORK Photorespiratory compensatory     LEAF5A.69    
C                                 !      point (mol/m3).                   LEAF5A.70    
     +,CONV(LAND_PTS)             ! WORK Factor for converting mol/m3      LEAF5A.71    
C                                 !      into Pa (J/mol).                  LEAF5A.72    
     +,DENOM(LAND_PTS)            ! WORK Denominator in equation for VCM   LEAF5A.73    
     +,GLCO2(LAND_PTS)            ! WORK Leaf conductance for CO2 (m/s).   LEAF5A.74    
     +,KC(LAND_PTS)               ! WORK Michaelis constant for CO2 (Pa)   LEAF5A.75    
     +,KO(LAND_PTS)               ! WORK Michaelis constant for O2 (Pa).   LEAF5A.76    
     +,QTENF(LAND_PTS)            ! WORK Q10 function.                     LEAF5A.77    
     +,TAU(LAND_PTS)              ! WORK CO2/O2 specificity ratio.         LEAF5A.78    
     +,TDEGC(LAND_PTS)            ! WORK Leaf temperature (deg C).         LEAF5A.79    
     +,VCM(LAND_PTS)              ! WORK Maximum rate of carboxylation     LEAF5A.80    
C                                 !      of Rubisco (mol CO2/m2/s).        LEAF5A.81    
     +,VCMAX(LAND_PTS)            ! WORK Maximum rate of carboxylation     LEAF5A.82    
C                                 !      of Rubisco - without the          LEAF5A.83    
C                                 !      temperature factor                LEAF5A.84    
C                                 !      (mol CO2/m2/s).                   LEAF5A.85    
     +,WL(LAND_PTS)               ! WORK Gross leaf phtosynthesis          LEAF5A.86    
C                                 !      (mol CO2/m2/s).                   LEAF5A.87    
     +,WCARB(LAND_PTS)            ! WORK Carboxylation,                    LEAF5A.88    
     +,WLITE(LAND_PTS)            !      Light, and                        LEAF5A.89    
     +,WEXPT(LAND_PTS)            !      export limited gross              LEAF5A.90    
C                                 !      photosynthetic rates              LEAF5A.91    
C                                 !      (mol CO2/m2/s).                   LEAF5A.92    
     +,WP(LAND_PTS)               ! WORK Smoothed minimum of               LEAF5A.93    
C                                 !      Carboxylation and Light           LEAF5A.94    
C                                 !      limited gross photosynthesis      LEAF5A.95    
C                                 !      (mol CO2/m2/s).                   LEAF5A.96    
                                                                           LEAF5A.97    
      INTEGER                                                              LEAF5A.98    
     + CLOS_INDEX(LAND_PTS)       ! WORK Index of land points              LEAF5A.99    
C                                 !      with closed stomata.              LEAF5A.100   
     +,CLOS_PTS                   ! WORK Number of land points             LEAF5A.101   
C                                 !      with closed stomata.              LEAF5A.102   
     +,OPEN_INDEX(LAND_PTS)       ! WORK Index of land points              LEAF5A.103   
C                                 !      with open stomata.                LEAF5A.104   
     +,OPEN_PTS                   ! WORK Number of land points             LEAF5A.105   
C                                 !      with open stomata.                LEAF5A.106   
                                                                           LEAF5A.107   
      LOGICAL                                                              LEAF5A.108   
     + LTIMER                                                              LEAF5A.109   
                                                                           LEAF5A.110   
      INTEGER                                                              LEAF5A.111   
     + I,J,L                      ! WORK Loop counters.                    LEAF5A.112   
                                                                           LEAF5A.113   
C-----------------------------------------------------------------------   LEAF5A.114   
C Functional Type dependent parameters                                     LEAF5A.115   
C-----------------------------------------------------------------------   LEAF5A.116   
      INTEGER                                                              LEAF5A.117   
     + C3(4)                      ! 1 for C3 Plants, 0 for C4 Plants.      LEAF5A.118   
                                                                           LEAF5A.119   
      REAL                                                                 LEAF5A.120   
     + ALPHA(4)                   ! Quantum efficiency                     LEAF5A.121   
C                                 ! (mol CO2/mol PAR photons).             LEAF5A.122   
     +,DQCRIT(4)                  ! Critical humidity deficit              LEAF5A.123   
C                                 ! (kg H2O/kg air).                       LEAF5A.124   
     +,F0(4)                      ! CI/CA for DQ = 0.                      LEAF5A.125   
     +,GLMIN(4)                   ! Minimum leaf conductance for H2O       LEAF5A.126   
C                                 ! (m/s).                                 LEAF5A.127   
C----------------------------------------------------------------------    LEAF5A.128   
C                        BT     NT    C3G    C4G                           LEAF5A.129   
C----------------------------------------------------------------------    LEAF5A.130   
      DATA C3      /      1,     1,     1,     0 /                         LEAF5A.131   
      DATA ALPHA   /   0.08,  0.08,  0.08, 0.040 /                         LEAF5A.132   
      DATA DQCRIT  /  0.090, 0.060, 0.150, 0.075 /                         LEAF5A.133   
      DATA F0      /  0.875, 0.875, 0.925, 0.800 /                         LEAF5A.134   
      DATA GLMIN   / 1.0E-6,1.0E-6,1.0E-6,1.0E-6 /                         LEAF5A.135   
                                                                           LEAF5A.136   
C-------------------------------------------------------------------       LEAF5A.137   
C Parameters                                                               LEAF5A.138   
C-------------------------------------------------------------------       LEAF5A.139   
      REAL                                                                 LEAF5A.140   
     + BETA1, BETA2   ! Coupling coefficients for co-limitation.           LEAF5A.141   
     +,FDC3, FDC4     ! Dark respiration coefficients for C3, C4           LEAF5A.142   
     +,NEFFC3, NEFFC4 ! Constant relating VCMAX and leaf N                 LEAF5A.143   
C                     ! from Schulze et al. 1994 (AMAX = 0.4E-3 * NL       LEAF5A.144   
C                     ! - assuming dry matter is 40% carbon by mass)       LEAF5A.145   
C                     ! and Jacobs 1994:                                   LEAF5A.146   
C                     ! C3 : VCMAX = 2 * AMAX ; C4 : VCMAX = AMAX          LEAF5A.147   
C                     ! (mol/m2/s)                                         LEAF5A.148   
     +,R              ! Gas constant (J/K/mol).                            LEAF5A.149   
     +,RATIO          ! Ratio of leaf resistance for CO2 to leaf           LEAF5A.150   
C                     ! resistance for H2O.                                LEAF5A.151   
     +,ZERODEGC       ! Zero Celsius (K).                                  LEAF5A.152   
                                                                           LEAF5A.153   
      PARAMETER (BETA1 = 0.83, BETA2 = 0.93                                LEAF5A.154   
     +,          FDC3 = 0.015,  FDC4 = 0.025                               LEAF5A.155   
     +,          NEFFC3 = 0.8E-3, NEFFC4 = 0.4E-3                          LEAF5A.156   
     +,          R = 8.3144  , RATIO = 1.6                                 LEAF5A.157   
     +,          ZERODEGC = 273.15)                                        LEAF5A.158   
                                                                           LEAF5A.159   
      IF (LTIMER) THEN                                                     LEAF5A.160   
        CALL TIMER('LEAF_C3  ',103)                                        GPB8F405.160   
      ENDIF                                                                LEAF5A.162   
                                                                           LEAF5A.163   
!----------------------------------------------------------------------    LEAF5A.164   
! Initialise counters                                                      LEAF5A.165   
!----------------------------------------------------------------------    LEAF5A.166   
      CLOS_PTS = 0                                                         LEAF5A.167   
      OPEN_PTS = 0                                                         LEAF5A.168   
                                                                           LEAF5A.169   
      DO J=1,VEG_PTS                                                       LEAF5A.170   
        L = VEG_INDEX(J)                                                   LEAF5A.171   
C----------------------------------------------------------------------    LEAF5A.172   
C Only carry out calculations for points with C3 plants                    LEAF5A.173   
C----------------------------------------------------------------------    LEAF5A.174   
        IF (C3(FT(L)).EQ.1) THEN                                           LEAF5A.175   
                                                                           LEAF5A.176   
C----------------------------------------------------------------------    LEAF5A.177   
C Calculate the points with closed stomata                                 LEAF5A.178   
C----------------------------------------------------------------------    LEAF5A.179   
          IF (FSMC(L).EQ.0.0 .OR. DQ(L).GE.DQCRIT(FT(L))                   LEAF5A.180   
     &                       .OR. APAR(L).LE.0.0) THEN                     LEAF5A.181   
            CLOS_PTS = CLOS_PTS + 1                                        LEAF5A.182   
            CLOS_INDEX(CLOS_PTS) = J                                       LEAF5A.183   
          ELSE                                                             LEAF5A.184   
            OPEN_PTS = OPEN_PTS + 1                                        LEAF5A.185   
            OPEN_INDEX(OPEN_PTS) = J                                       LEAF5A.186   
          ENDIF                                                            LEAF5A.187   
                                                                           LEAF5A.188   
        ENDIF                                                              LEAF5A.189   
                                                                           LEAF5A.190   
      ENDDO                                                                LEAF5A.191   
                                                                           LEAF5A.192   
C----------------------------------------------------------------------    LEAF5A.193   
C Calculate the photosynthetic parameters                                  LEAF5A.194   
C----------------------------------------------------------------------    LEAF5A.195   
CDIR$ IVDEP                                                                LEAF5A.196   
! Fujitsu vectorization directive                                          GRB0F405.367   
!OCL NOVREC                                                                GRB0F405.368   
      DO J=1,OPEN_PTS                                                      LEAF5A.197   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.198   
        I = LAND_INDEX(L) - (P1-1)                                         LEAF5A.199   
                                                                           LEAF5A.200   
        VCMAX(L) = NEFFC3 * NL0(L)                                         LEAF5A.201   
        TDEGC(L) = TL(I) - ZERODEGC                                        LEAF5A.202   
                                                                           LEAF5A.203   
        TAU(L) = 2600.0 * (0.57 ** (0.1 * (TDEGC(L) - 25.0)))              LEAF5A.204   
        CCP(L) = 0.5 * OA(L) / TAU(L)                                      LEAF5A.205   
                                                                           LEAF5A.206   
                                                                           LEAF5A.207   
        QTENF(L) = VCMAX(L) * (2.0 ** (0.1 * (TDEGC(L) - 25.0)))           LEAF5A.208   
        DENOM(L) = (1 + EXP (0.3 * (TDEGC(L) - 36.0)))                     LEAF5A.209   
        VCM(L) = QTENF(L) / DENOM(L)                                       LEAF5A.210   
        RD(L) = FDC3 * VCM(L)                                              LEAF5A.211   
                                                                           LEAF5A.212   
C----------------------------------------------------------------------    LEAF5A.213   
C Calculate the factor for converting mol/m3 into Pa (J/m3).               LEAF5A.214   
C----------------------------------------------------------------------    LEAF5A.215   
        CONV(L) = R * TL(I)                                                LEAF5A.216   
                                                                           LEAF5A.217   
      ENDDO                                                                LEAF5A.218   
                                                                           LEAF5A.219   
CDIR$ IVDEP                                                                LEAF5A.220   
! Fujitsu vectorization directive                                          GRB0F405.369   
!OCL NOVREC                                                                GRB0F405.370   
      DO J=1,CLOS_PTS                                                      LEAF5A.221   
        L = VEG_INDEX(CLOS_INDEX(J))                                       LEAF5A.222   
        I = LAND_INDEX(L) - (P1-1)                                         LEAF5A.223   
                                                                           LEAF5A.224   
        VCMAX(L) = NEFFC3 * NL0(L)                                         LEAF5A.225   
        TDEGC(L) = TL(I) - ZERODEGC                                        LEAF5A.226   
                                                                           LEAF5A.227   
        QTENF(L) = VCMAX(L) * (2.0 ** (0.1 * (TDEGC(L) - 25.0)))           LEAF5A.228   
        DENOM(L) = (1 + EXP (0.3 * (TDEGC(L) - 36.0)))                     LEAF5A.229   
        VCM(L) = QTENF(L) / DENOM(L)                                       LEAF5A.230   
        RD(L) = FDC3 * VCM(L)                                              LEAF5A.231   
                                                                           LEAF5A.232   
C----------------------------------------------------------------------    LEAF5A.233   
C Calculate the factor for converting mol/m3 into Pa (J/m3).               LEAF5A.234   
C----------------------------------------------------------------------    LEAF5A.235   
        CONV(L) = R * TL(I)                                                LEAF5A.236   
                                                                           LEAF5A.237   
      ENDDO                                                                LEAF5A.238   
                                                                           LEAF5A.239   
C----------------------------------------------------------------------    LEAF5A.240   
C Carry out calculations for points with open stomata                      LEAF5A.241   
C----------------------------------------------------------------------    LEAF5A.242   
      DO J=1,OPEN_PTS                                                      LEAF5A.243   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.244   
                                                                           LEAF5A.245   
C----------------------------------------------------------------------    LEAF5A.246   
C Calculate the internal CO2 pressure (Jacobs, 1994).                      LEAF5A.247   
C----------------------------------------------------------------------    LEAF5A.248   
        CI(L) = (CA(L) - CCP(L)) * F0(FT(L))                               LEAF5A.249   
     &        * (1 - DQ(L) / DQCRIT(FT(L))) + CCP(L)                       LEAF5A.250   
                                                                           LEAF5A.251   
C----------------------------------------------------------------------    LEAF5A.252   
C Convert absorbed PAR into mol PAR photons/m2/s                           LEAF5A.253   
C----------------------------------------------------------------------    LEAF5A.254   
        ACR(L) = APAR(L) / 2.19E5                                          LEAF5A.255   
                                                                           LEAF5A.256   
      ENDDO                                                                LEAF5A.257   
                                                                           LEAF5A.258   
C----------------------------------------------------------------------    LEAF5A.259   
C Calculate the gross photosynthesis for RuBP-Carboxylase, Light and       LEAF5A.260   
C Export limited photosynthesis (Collatz et al., 1992).                    LEAF5A.261   
C----------------------------------------------------------------------    LEAF5A.262   
CDIR$ IVDEP                                                                LEAF5A.263   
! Fujitsu vectorization directive                                          GRB0F405.371   
!OCL NOVREC                                                                GRB0F405.372   
      DO J=1,OPEN_PTS                                                      LEAF5A.264   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.265   
                                                                           LEAF5A.266   
        KC(L) = 30.0 * (2.1 ** (0.1 * (TDEGC(L) - 25.0)))                  LEAF5A.267   
        KO(L) = 30000.0 * (1.2 ** (0.1 * (TDEGC(L) - 25.0)))               LEAF5A.268   
                                                                           LEAF5A.269   
        WCARB(L) = VCM(L) * (CI(L) - CCP(L))                               LEAF5A.270   
     &           / (CI(L) + KC(L) * (1. + OA(L) / KO(L)))                  LEAF5A.271   
                                                                           LEAF5A.272   
        WLITE(L) = ALPHA(FT(L)) * ACR(L) * (CI(L) - CCP(L))                LEAF5A.273   
     &           / (CI(L) + 2 * CCP(L))                                    LEAF5A.274   
                                                                           LEAF5A.275   
        WEXPT(L) = 0.5 * VCM(L)                                            LEAF5A.276   
                                                                           LEAF5A.277   
      ENDDO                                                                LEAF5A.278   
                                                                           LEAF5A.279   
C----------------------------------------------------------------------    LEAF5A.280   
C Calculate the co-limited rate of gross photosynthesis                    LEAF5A.281   
C----------------------------------------------------------------------    LEAF5A.282   
                                                                           LEAF5A.283   
CDIR$ IVDEP                                                                LEAF5A.284   
! Fujitsu vectorization directive                                          GRB0F405.373   
!OCL NOVREC                                                                GRB0F405.374   
      DO J=1,OPEN_PTS                                                      LEAF5A.285   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.286   
                                                                           LEAF5A.287   
        B1(L) = BETA1                                                      LEAF5A.288   
        B2(L) = - (WCARB(L) + WLITE(L))                                    LEAF5A.289   
        B3(L) = WCARB(L) * WLITE(L)                                        LEAF5A.290   
                                                                           LEAF5A.291   
        WP(L) = -B2(L)/(2*B1(L))                                           LEAF5A.292   
     .         - SQRT(B2(L)*B2(L)/(4*B1(L)*B1(L)) - B3(L)/B1(L))           LEAF5A.293   
                                                                           LEAF5A.294   
      ENDDO                                                                LEAF5A.295   
                                                                           LEAF5A.296   
CDIR$ IVDEP                                                                LEAF5A.297   
! Fujitsu vectorization directive                                          GRB0F405.375   
!OCL NOVREC                                                                GRB0F405.376   
      DO J=1,OPEN_PTS                                                      LEAF5A.298   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.299   
                                                                           LEAF5A.300   
        B1(L) = BETA2                                                      LEAF5A.301   
        B2(L) = - (WP(L) + WEXPT(L))                                       LEAF5A.302   
        B3(L) = WP(L) * WEXPT(L)                                           LEAF5A.303   
                                                                           LEAF5A.304   
        WL(L) = -B2(L)/(2*B1(L))                                           LEAF5A.305   
     .         - SQRT(B2(L)*B2(L)/(4*B1(L)*B1(L)) - B3(L)/B1(L))           LEAF5A.306   
                                                                           LEAF5A.307   
      ENDDO                                                                LEAF5A.308   
                                                                           LEAF5A.309   
C----------------------------------------------------------------------    LEAF5A.310   
C Carry out calculations for points with open stomata                      LEAF5A.311   
C----------------------------------------------------------------------    LEAF5A.312   
CDIR$ IVDEP                                                                LEAF5A.313   
! Fujitsu vectorization directive                                          GRB0F405.377   
!OCL NOVREC                                                                GRB0F405.378   
      DO J=1,OPEN_PTS                                                      LEAF5A.314   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.315   
                                                                           LEAF5A.316   
C----------------------------------------------------------------------    LEAF5A.317   
C Calculate the net rate of photosynthesis                                 LEAF5A.318   
C----------------------------------------------------------------------    LEAF5A.319   
        AL(L) = (WL(L) - RD(L)) * FSMC(L)                                  LEAF5A.320   
                                                                           LEAF5A.321   
C----------------------------------------------------------------------    LEAF5A.322   
C Diagnose the leaf conductance                                            LEAF5A.323   
C----------------------------------------------------------------------    LEAF5A.324   
        GLCO2(L) = (AL(L) * CONV(L)) / (CA(L) - CI(L))                     LEAF5A.325   
        GL(L) = RATIO * GLCO2(L)                                           LEAF5A.326   
                                                                           LEAF5A.327   
      ENDDO                                                                LEAF5A.328   
                                                                           LEAF5A.329   
C----------------------------------------------------------------------    LEAF5A.330   
C Close stomata at points with negative or zero net photosynthesis         LEAF5A.331   
C or where the leaf resistance exceeds its maximum value.                  LEAF5A.332   
C----------------------------------------------------------------------    LEAF5A.333   
CDIR$ IVDEP                                                                LEAF5A.334   
! Fujitsu vectorization directive                                          GRB0F405.379   
!OCL NOVREC                                                                GRB0F405.380   
      DO J=1,OPEN_PTS                                                      LEAF5A.335   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.336   
                                                                           LEAF5A.337   
        IF (GL(L).LE.GLMIN(FT(L)) .OR. AL(L).LE.0.0) THEN                  LEAF5A.338   
          GL(L) = GLMIN(FT(L))                                             LEAF5A.339   
          GLCO2(L) = GL(L) / RATIO                                         LEAF5A.340   
          AL(L) = -RD(L) * FSMC(L)                                         LEAF5A.341   
          CI(L) = CA(L) - AL(L) * CONV(L) / GLCO2(L)                       LEAF5A.342   
        ENDIF                                                              LEAF5A.343   
                                                                           LEAF5A.344   
      ENDDO                                                                LEAF5A.345   
                                                                           LEAF5A.346   
C----------------------------------------------------------------------    LEAF5A.347   
C Define fluxes and conductances for points with closed stomata            LEAF5A.348   
C----------------------------------------------------------------------    LEAF5A.349   
CDIR$ IVDEP                                                                LEAF5A.350   
! Fujitsu vectorization directive                                          GRB0F405.381   
!OCL NOVREC                                                                GRB0F405.382   
      DO J=1,CLOS_PTS                                                      LEAF5A.351   
        L = VEG_INDEX(CLOS_INDEX(J))                                       LEAF5A.352   
                                                                           LEAF5A.353   
        GL(L) = GLMIN(FT(L))                                               LEAF5A.354   
        GLCO2(L) = GL(L) / RATIO                                           LEAF5A.355   
        AL(L) = -RD(L) * FSMC(L)                                           LEAF5A.356   
        CI(L) = CA(L) - AL(L) * CONV(L) / GLCO2(L)                         LEAF5A.357   
                                                                           LEAF5A.358   
      ENDDO                                                                LEAF5A.359   
                                                                           LEAF5A.360   
      IF (LTIMER) THEN                                                     LEAF5A.361   
        CALL TIMER('LEAF_C3  ',104)                                        GPB8F405.161   
      ENDIF                                                                LEAF5A.363   
                                                                           LEAF5A.364   
      RETURN                                                               LEAF5A.365   
      END                                                                  LEAF5A.366   
                                                                           LEAF5A.367   
C**********************************************************************    LEAF5A.368   
C Calculates the leaf resistance and net photosynthesis using:             LEAF5A.369   
C  (i) Collatz et al. (1991) C4 photosynthesis model                       LEAF5A.370   
C (ii) Jacobs (1994) CI/CA closure.                                        LEAF5A.371   
C                                                                          LEAF5A.372   
C Written by Peter Cox (February 1996)                                     LEAF5A.373   
C**********************************************************************    LEAF5A.374   
      SUBROUTINE LEAF_C4 (LAND_PTS,LAND_INDEX,P1,P_POINTS                  LEAF5A.375   
     +,                   VEG_PTS,VEG_INDEX                                LEAF5A.376   
     +,                   FT,DQ,APAR,TL,CA,OA,PSTAR                        LEAF5A.377   
     +,                   NL0,FSMC                                         LEAF5A.378   
     +,                   GL,AL,CI,RD,LTIMER)                              LEAF5A.379   
                                                                           LEAF5A.380   
      IMPLICIT NONE                                                        LEAF5A.381   
                                                                           LEAF5A.382   
      INTEGER                                                              LEAF5A.383   
     + LAND_PTS                   ! IN Number of land points to be         LEAF5A.384   
C                                 !    processed.                          LEAF5A.385   
     +,LAND_INDEX(LAND_PTS)       ! IN Index of land points.               LEAF5A.386   
     +,P1                         ! IN First P point to be processed.      LEAF5A.387   
     +,P_POINTS                   ! IN Number of P points to be            LEAF5A.388   
C                                 !    processed.                          LEAF5A.389   
     +,VEG_PTS                    ! IN Number of vegetated points.         LEAF5A.390   
     +,VEG_INDEX(LAND_PTS)        ! IN Index of vegetated points           LEAF5A.391   
C                                 !    on the land grid.                   LEAF5A.392   
                                                                           LEAF5A.393   
      INTEGER                                                              LEAF5A.394   
     + FT(LAND_PTS)               ! IN Plant functional type.              LEAF5A.395   
                                                                           LEAF5A.396   
      REAL                                                                 LEAF5A.397   
     + DQ(LAND_PTS)               ! IN Canopy level specific humidity      LEAF5A.398   
C                                 !    deficit (kg H2O/kg air).            LEAF5A.399   
     +,APAR(LAND_PTS)             ! IN Absorbed PAR (W/m2)                 LEAF5A.400   
     +,TL(P_POINTS)               ! IN Leaf temperature (K).               LEAF5A.401   
     +,CA(LAND_PTS)               ! IN Canopy CO2 pressure (Pa).           LEAF5A.402   
     +,OA(LAND_PTS)               ! IN Atmospheric O2 pressure (Pa).       LEAF5A.403   
     +,PSTAR(P_POINTS)            ! IN Atmospheric pressure (Pa).          LEAF5A.404   
     +,NL0(LAND_PTS)               ! IN Leaf nitrogen conncentration       LEAF5A.405   
C                                 !    (kg N/kg C).                        LEAF5A.406   
     +,FSMC(LAND_PTS)             ! IN Soil water factor.                  LEAF5A.407   
     +,GL(LAND_PTS)               ! OUT Leaf conductance for H2O (m/s).    LEAF5A.408   
     +,AL(LAND_PTS)               ! OUT Net Leaf photosynthesis            LEAF5A.409   
C                                 !     (mol CO2/m2/s).                    LEAF5A.410   
     +,RD(LAND_PTS)               ! OUT Dark respiration (mol CO2/m2/s).   LEAF5A.411   
     +,CI(LAND_PTS)               ! OUT Internal CO2 pressure (Pa).        LEAF5A.412   
     +,ACR(LAND_PTS)              ! WORK Absorbed PAR                      LEAF5A.413   
C                                 !      (mol photons/m2/s).               LEAF5A.414   
     +,B1(LAND_PTS)               !                                        LEAF5A.415   
     +,B2(LAND_PTS)               !                                        LEAF5A.416   
     +,B3(LAND_PTS)               ! WORK Coefficients of the quadratic.    LEAF5A.417   
     +,CCP(LAND_PTS)              ! WORK Photorespiratory compensatory     LEAF5A.418   
C                                 !      point (mol/m3).                   LEAF5A.419   
     +,CONV(LAND_PTS)             ! WORK Factor for converting mol/m3      LEAF5A.420   
C                                 !      into Pa (J/mol).                  LEAF5A.421   
     +,DENOM(LAND_PTS)            ! WORK Denominator in equation for VCM   LEAF5A.422   
     +,GLCO2(LAND_PTS)            ! WORK Leaf conductance for CO2 (m/s).   LEAF5A.423   
     +,QTENF(LAND_PTS)            ! WORK Q10 function.                     LEAF5A.424   
     +,TDEGC(LAND_PTS)            ! WORK Leaf temperature (deg C).         LEAF5A.425   
     +,VCM(LAND_PTS)              ! WORK Maximum rate of carboxylation     LEAF5A.426   
C                                 !      of Rubisco (mol CO2/m2/s).        LEAF5A.427   
     +,VCMAX(LAND_PTS)            ! WORK Maximum rate of carboxylation     LEAF5A.428   
C                                 !      of Rubisco - without the          LEAF5A.429   
C                                 !      temperature factor                LEAF5A.430   
C                                 !      (mol CO2/m2/s).                   LEAF5A.431   
     +,WL(LAND_PTS)               ! WORK Gross leaf phtosynthesis          LEAF5A.432   
C                                 !      (mol CO2/m2/s).                   LEAF5A.433   
     +,WCARB(LAND_PTS)            ! WORK Carboxylation,                    LEAF5A.434   
     +,WLITE(LAND_PTS)            !      Light, and                        LEAF5A.435   
     +,WEXPT(LAND_PTS)            !      export limited gross              LEAF5A.436   
C                                 !      photosynthetic rates              LEAF5A.437   
C                                 !      (mol CO2/m2/s).                   LEAF5A.438   
     +,WP(LAND_PTS)               ! WORK Smoothed minimum of               LEAF5A.439   
C                                 !      Carboxylation and Light           LEAF5A.440   
C                                 !      limited gross photosynthesis      LEAF5A.441   
C                                 !      (mol CO2/m2/s).                   LEAF5A.442   
                                                                           LEAF5A.443   
      INTEGER                                                              LEAF5A.444   
     + CLOS_INDEX(LAND_PTS)       ! WORK Index of land points              LEAF5A.445   
C                                 !      with closed stomata.              LEAF5A.446   
     +,CLOS_PTS                   ! WORK Number of land points             LEAF5A.447   
C                                 !      with closed stomata.              LEAF5A.448   
     +,OPEN_INDEX(LAND_PTS)       ! WORK Index of land points              LEAF5A.449   
C                                 !      with open stomata.                LEAF5A.450   
     +,OPEN_PTS                   ! WORK Number of land points             LEAF5A.451   
C                                 !      with open stomata.                LEAF5A.452   
                                                                           LEAF5A.453   
      LOGICAL                                                              LEAF5A.454   
     + LTIMER                                                              LEAF5A.455   
                                                                           LEAF5A.456   
      INTEGER                                                              LEAF5A.457   
     + I,J,L                      ! WORK Loop counters.                    LEAF5A.458   
                                                                           LEAF5A.459   
C-----------------------------------------------------------------------   LEAF5A.460   
C Functional Type dependent parameters                                     LEAF5A.461   
C-----------------------------------------------------------------------   LEAF5A.462   
      INTEGER                                                              LEAF5A.463   
     + C3(4)                      ! 1 for C3 Plants, 0 for C4 Plants.      LEAF5A.464   
                                                                           LEAF5A.465   
      REAL                                                                 LEAF5A.466   
     + ALPHA(4)                   ! Quantum efficiency                     LEAF5A.467   
C                                 ! (mol CO2/mol PAR photons).             LEAF5A.468   
     +,DQCRIT(4)                  ! Critical humidity deficit              LEAF5A.469   
C                                 ! (kg H2O/kg air).                       LEAF5A.470   
     +,F0(4)                      ! CI/CA for DQ = 0.                      LEAF5A.471   
     +,GLMIN(4)                   ! Minimum leaf conductance for H2O       LEAF5A.472   
C                                 ! (m/s).                                 LEAF5A.473   
C----------------------------------------------------------------------    LEAF5A.474   
C                        BT     NT    C3G    C4G                           LEAF5A.475   
C----------------------------------------------------------------------    LEAF5A.476   
      DATA C3      /      1,     1,     1,     0 /                         LEAF5A.477   
      DATA ALPHA   /   0.08,  0.08,  0.08, 0.040 /                         LEAF5A.478   
      DATA DQCRIT  /  0.090, 0.060, 0.150, 0.075 /                         LEAF5A.479   
      DATA F0      /  0.875, 0.875, 0.925, 0.800 /                         LEAF5A.480   
      DATA GLMIN   / 1.0E-6,1.0E-6,1.0E-6,1.0E-6 /                         LEAF5A.481   
                                                                           LEAF5A.482   
C-------------------------------------------------------------------       LEAF5A.483   
C Parameters                                                               LEAF5A.484   
C-------------------------------------------------------------------       LEAF5A.485   
      REAL                                                                 LEAF5A.486   
     + BETA1, BETA2   ! Coupling coefficients for co-limitation.           LEAF5A.487   
     +,FDC3, FDC4     ! Dark respiration coefficients for C3, C4           LEAF5A.488   
     +,NEFFC3, NEFFC4 ! Constant relating VCMAX and leaf N                 LEAF5A.489   
C                     ! from Schulze et al. 1994 (AMAX = 0.4E-3 * NL       LEAF5A.490   
C                     ! - assuming dry matter is 40% carbon by mass)       LEAF5A.491   
C                     ! and Jacobs 1994:                                   LEAF5A.492   
C                     ! C3 : VCMAX = 2 * AMAX ; C4 : VCMAX = AMAX          LEAF5A.493   
C                     ! (mol/m2/s)                                         LEAF5A.494   
     +,R              ! Gas constant (J/K/mol).                            LEAF5A.495   
     +,RATIO          ! Ratio of leaf resistance for CO2 to leaf           LEAF5A.496   
C                     ! resistance for H2O.                                LEAF5A.497   
     +,ZERODEGC       ! Zero Celsius (K).                                  LEAF5A.498   
                                                                           LEAF5A.499   
      PARAMETER (BETA1 = 0.83, BETA2 = 0.93                                LEAF5A.500   
     +,          FDC3 = 0.015,  FDC4 = 0.025                               LEAF5A.501   
     +,          NEFFC3 = 0.8E-3, NEFFC4 = 0.4E-3                          LEAF5A.502   
     +,          R = 8.3144  , RATIO = 1.6                                 LEAF5A.503   
     +,          ZERODEGC = 273.15)                                        LEAF5A.504   
                                                                           LEAF5A.505   
      IF (LTIMER) THEN                                                     LEAF5A.506   
        CALL TIMER('LEAF_C4  ',103)                                        GPB8F405.162   
      ENDIF                                                                LEAF5A.508   
                                                                           LEAF5A.509   
!----------------------------------------------------------------------    LEAF5A.510   
! Initialise counters                                                      LEAF5A.511   
!----------------------------------------------------------------------    LEAF5A.512   
      CLOS_PTS = 0                                                         LEAF5A.513   
      OPEN_PTS = 0                                                         LEAF5A.514   
                                                                           LEAF5A.515   
      DO J=1,VEG_PTS                                                       LEAF5A.516   
        L = VEG_INDEX(J)                                                   LEAF5A.517   
C----------------------------------------------------------------------    LEAF5A.518   
C Only carry out calculations for points with C4 plants                    LEAF5A.519   
C----------------------------------------------------------------------    LEAF5A.520   
        IF (C3(FT(L)).EQ.0) THEN                                           LEAF5A.521   
                                                                           LEAF5A.522   
C----------------------------------------------------------------------    LEAF5A.523   
C Calculate the points with closed stomata                                 LEAF5A.524   
C----------------------------------------------------------------------    LEAF5A.525   
          IF (FSMC(L).EQ.0.0 .OR. DQ(L).GE.DQCRIT(FT(L))                   LEAF5A.526   
     &                       .OR. APAR(L).LE.0.0) THEN                     LEAF5A.527   
            CLOS_PTS = CLOS_PTS + 1                                        LEAF5A.528   
            CLOS_INDEX(CLOS_PTS) = J                                       LEAF5A.529   
          ELSE                                                             LEAF5A.530   
            OPEN_PTS = OPEN_PTS + 1                                        LEAF5A.531   
            OPEN_INDEX(OPEN_PTS) = J                                       LEAF5A.532   
          ENDIF                                                            LEAF5A.533   
                                                                           LEAF5A.534   
        ENDIF                                                              LEAF5A.535   
                                                                           LEAF5A.536   
      ENDDO                                                                LEAF5A.537   
                                                                           LEAF5A.538   
C----------------------------------------------------------------------    LEAF5A.539   
C Calculate the photosynthetic parameters                                  LEAF5A.540   
C----------------------------------------------------------------------    LEAF5A.541   
CDIR$ IVDEP                                                                LEAF5A.542   
! Fujitsu vectorization directive                                          GRB0F405.383   
!OCL NOVREC                                                                GRB0F405.384   
      DO J=1,OPEN_PTS                                                      LEAF5A.543   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.544   
        I = LAND_INDEX(L) - (P1-1)                                         LEAF5A.545   
                                                                           LEAF5A.546   
        VCMAX(L) = NEFFC4 * NL0(L)                                         LEAF5A.547   
        TDEGC(L) = TL(I) - ZERODEGC                                        LEAF5A.548   
                                                                           LEAF5A.549   
        CCP(L) = 0.0                                                       LEAF5A.550   
                                                                           LEAF5A.551   
        QTENF(L) = VCMAX(L) * (2.0 ** (0.1 * (TDEGC(L) - 25.0)))           LEAF5A.552   
        DENOM(L) = (1 + EXP (0.3 * (TDEGC(L) - 36.0)))                     LEAF5A.553   
     &           * (1 + EXP (0.3 * (13.0 - TDEGC(L))))                     LEAF5A.554   
        VCM(L) = QTENF(L) / DENOM(L)                                       LEAF5A.555   
                                                                           LEAF5A.556   
        RD(L) = FDC4 * VCM(L)                                              LEAF5A.557   
                                                                           LEAF5A.558   
C----------------------------------------------------------------------    LEAF5A.559   
C Calculate the factor for converting mol/m3 into Pa (J/m3).               LEAF5A.560   
C----------------------------------------------------------------------    LEAF5A.561   
        CONV(L) = R * TL(I)                                                LEAF5A.562   
                                                                           LEAF5A.563   
      ENDDO                                                                LEAF5A.564   
                                                                           LEAF5A.565   
CDIR$ IVDEP                                                                LEAF5A.566   
! Fujitsu vectorization directive                                          GRB0F405.385   
!OCL NOVREC                                                                GRB0F405.386   
      DO J=1,CLOS_PTS                                                      LEAF5A.567   
        L = VEG_INDEX(CLOS_INDEX(J))                                       LEAF5A.568   
        I = LAND_INDEX(L) - (P1-1)                                         LEAF5A.569   
                                                                           LEAF5A.570   
        VCMAX(L) = NEFFC4 * NL0(L)                                         LEAF5A.571   
        TDEGC(L) = TL(I) - ZERODEGC                                        LEAF5A.572   
                                                                           LEAF5A.573   
        QTENF(L) = VCMAX(L) * (2.0 ** (0.1 * (TDEGC(L) - 25.0)))           LEAF5A.574   
        DENOM(L) = (1 + EXP (0.3 * (TDEGC(L) - 36.0)))                     LEAF5A.575   
     &           * (1 + EXP (0.3 * (13.0 - TDEGC(L))))                     LEAF5A.576   
        VCM(L) = QTENF(L) / DENOM(L)                                       LEAF5A.577   
                                                                           LEAF5A.578   
        RD(L) = FDC4 * VCM(L)                                              LEAF5A.579   
                                                                           LEAF5A.580   
C----------------------------------------------------------------------    LEAF5A.581   
C Calculate the factor for converting mol/m3 into Pa (J/m3).               LEAF5A.582   
C----------------------------------------------------------------------    LEAF5A.583   
        CONV(L) = R * TL(I)                                                LEAF5A.584   
                                                                           LEAF5A.585   
      ENDDO                                                                LEAF5A.586   
                                                                           LEAF5A.587   
C----------------------------------------------------------------------    LEAF5A.588   
C Carry out calculations for points with open stomata                      LEAF5A.589   
C----------------------------------------------------------------------    LEAF5A.590   
      DO J=1,OPEN_PTS                                                      LEAF5A.591   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.592   
                                                                           LEAF5A.593   
C----------------------------------------------------------------------    LEAF5A.594   
C Calculate the internal CO2 pressure (Jacobs, 1994).                      LEAF5A.595   
C----------------------------------------------------------------------    LEAF5A.596   
        CI(L) = (CA(L) - CCP(L)) * F0(FT(L))                               LEAF5A.597   
     &        * (1 - DQ(L) / DQCRIT(FT(L))) + CCP(L)                       LEAF5A.598   
                                                                           LEAF5A.599   
C----------------------------------------------------------------------    LEAF5A.600   
C Convert absorbed PAR into mol PAR photons/m2/s                           LEAF5A.601   
C----------------------------------------------------------------------    LEAF5A.602   
        ACR(L) = APAR(L) / 2.19E5                                          LEAF5A.603   
                                                                           LEAF5A.604   
      ENDDO                                                                LEAF5A.605   
                                                                           LEAF5A.606   
C----------------------------------------------------------------------    LEAF5A.607   
C Calculate the gross photosynthesis for RuBP-Carboxylase, Light and       LEAF5A.608   
C Export limited photosynthesis (Collatz et al., 1992).                    LEAF5A.609   
C----------------------------------------------------------------------    LEAF5A.610   
      DO J=1,OPEN_PTS                                                      LEAF5A.611   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.612   
        I = LAND_INDEX(L) - (P1-1)                                         LEAF5A.613   
                                                                           LEAF5A.614   
        WCARB(L) = VCM(L)                                                  LEAF5A.615   
                                                                           LEAF5A.616   
        WLITE(L) = ALPHA(FT(L)) * ACR(L)                                   LEAF5A.617   
                                                                           LEAF5A.618   
        WEXPT(L) = 20000.0 * VCM(L) * CI(L) / PSTAR(I)                     LEAF5A.619   
                                                                           LEAF5A.620   
      ENDDO                                                                LEAF5A.621   
                                                                           LEAF5A.622   
C----------------------------------------------------------------------    LEAF5A.623   
C Calculate the co-limited rate of gross photosynthesis                    LEAF5A.624   
C----------------------------------------------------------------------    LEAF5A.625   
                                                                           LEAF5A.626   
CDIR$ IVDEP                                                                LEAF5A.627   
! Fujitsu vectorization directive                                          GRB0F405.387   
!OCL NOVREC                                                                GRB0F405.388   
      DO J=1,OPEN_PTS                                                      LEAF5A.628   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.629   
                                                                           LEAF5A.630   
        B1(L) = BETA1                                                      LEAF5A.631   
        B2(L) = - (WCARB(L) + WLITE(L))                                    LEAF5A.632   
        B3(L) = WCARB(L) * WLITE(L)                                        LEAF5A.633   
                                                                           LEAF5A.634   
        WP(L) = -B2(L)/(2*B1(L))                                           LEAF5A.635   
     .         - SQRT(B2(L)*B2(L)/(4*B1(L)*B1(L)) - B3(L)/B1(L))           LEAF5A.636   
                                                                           LEAF5A.637   
      ENDDO                                                                LEAF5A.638   
                                                                           LEAF5A.639   
CDIR$ IVDEP                                                                LEAF5A.640   
! Fujitsu vectorization directive                                          GRB0F405.389   
!OCL NOVREC                                                                GRB0F405.390   
      DO J=1,OPEN_PTS                                                      LEAF5A.641   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.642   
                                                                           LEAF5A.643   
        B1(L) = BETA2                                                      LEAF5A.644   
        B2(L) = - (WP(L) + WEXPT(L))                                       LEAF5A.645   
        B3(L) = WP(L) * WEXPT(L)                                           LEAF5A.646   
                                                                           LEAF5A.647   
        WL(L) = -B2(L)/(2*B1(L))                                           LEAF5A.648   
     .         - SQRT(B2(L)*B2(L)/(4*B1(L)*B1(L)) - B3(L)/B1(L))           LEAF5A.649   
                                                                           LEAF5A.650   
      ENDDO                                                                LEAF5A.651   
                                                                           LEAF5A.652   
C----------------------------------------------------------------------    LEAF5A.653   
C Carry out calculations for points with open stomata                      LEAF5A.654   
C----------------------------------------------------------------------    LEAF5A.655   
CDIR$ IVDEP                                                                LEAF5A.656   
! Fujitsu vectorization directive                                          GRB0F405.391   
!OCL NOVREC                                                                GRB0F405.392   
      DO J=1,OPEN_PTS                                                      LEAF5A.657   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.658   
                                                                           LEAF5A.659   
C----------------------------------------------------------------------    LEAF5A.660   
C Calculate the net rate of photosynthesis                                 LEAF5A.661   
C----------------------------------------------------------------------    LEAF5A.662   
        AL(L) = (WL(L) - RD(L)) * FSMC(L)                                  LEAF5A.663   
                                                                           LEAF5A.664   
C----------------------------------------------------------------------    LEAF5A.665   
C Diagnose the leaf conductance                                            LEAF5A.666   
C----------------------------------------------------------------------    LEAF5A.667   
        GLCO2(L) = (AL(L) * CONV(L)) / (CA(L) - CI(L))                     LEAF5A.668   
        GL(L) = GLCO2(L) * RATIO                                           LEAF5A.669   
                                                                           LEAF5A.670   
      ENDDO                                                                LEAF5A.671   
                                                                           LEAF5A.672   
C----------------------------------------------------------------------    LEAF5A.673   
C Close stomata at points with negative or zero net photosynthesis         LEAF5A.674   
C or where the leaf resistance exceeds its maximum value.                  LEAF5A.675   
C----------------------------------------------------------------------    LEAF5A.676   
CDIR$ IVDEP                                                                LEAF5A.677   
! Fujitsu vectorization directive                                          GRB0F405.393   
!OCL NOVREC                                                                GRB0F405.394   
      DO J=1,OPEN_PTS                                                      LEAF5A.678   
        L = VEG_INDEX(OPEN_INDEX(J))                                       LEAF5A.679   
                                                                           LEAF5A.680   
        IF (GL(L).LE.GLMIN(FT(L)) .OR. AL(L).LE.0.0) THEN                  LEAF5A.681   
          GL(L) = GLMIN(FT(L))                                             LEAF5A.682   
          GLCO2(L) = GL(L) / RATIO                                         LEAF5A.683   
          AL(L) = -RD(L) * FSMC(L)                                         LEAF5A.684   
          CI(L) = CA(L) - AL(L) * CONV(L) / GLCO2(L)                       LEAF5A.685   
        ENDIF                                                              LEAF5A.686   
                                                                           LEAF5A.687   
      ENDDO                                                                LEAF5A.688   
                                                                           LEAF5A.689   
C----------------------------------------------------------------------    LEAF5A.690   
C Define fluxes and conductances for points with closed stomata            LEAF5A.691   
C----------------------------------------------------------------------    LEAF5A.692   
CDIR$ IVDEP                                                                LEAF5A.693   
! Fujitsu vectorization directive                                          GRB0F405.395   
!OCL NOVREC                                                                GRB0F405.396   
      DO J=1,CLOS_PTS                                                      LEAF5A.694   
        L = VEG_INDEX(CLOS_INDEX(J))                                       LEAF5A.695   
                                                                           LEAF5A.696   
        GL(L) = GLMIN(FT(L))                                               LEAF5A.697   
        GLCO2(L) = GL(L) / RATIO                                           LEAF5A.698   
        AL(L) = -RD(L) * FSMC(L)                                           LEAF5A.699   
        CI(L) = CA(L) - AL(L) * CONV(L) / GLCO2(L)                         LEAF5A.700   
                                                                           LEAF5A.701   
      ENDDO                                                                LEAF5A.702   
                                                                           LEAF5A.703   
      IF (LTIMER) THEN                                                     LEAF5A.704   
        CALL TIMER('LEAF_C4  ',104)                                        GPB8F405.163   
      ENDIF                                                                LEAF5A.706   
                                                                           LEAF5A.707   
      RETURN                                                               LEAF5A.708   
      END                                                                  LEAF5A.709   
*ENDIF                                                                     LEAF5A.710   
