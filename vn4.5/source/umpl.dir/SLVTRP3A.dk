*IF DEF,A70_1A                                                             SLVTRP3A.2     
*IF DEF,A01_3A,OR,DEF,A02_3A                                               SLVTRP3A.3     
C *****************************COPYRIGHT******************************     SLVTRP3A.4     
C (c) CROWN COPYRIGHT 1996, METEOROLOGICAL OFFICE, All Rights Reserved.    SLVTRP3A.5     
C                                                                          SLVTRP3A.6     
C Use, duplication or disclosure of this code is subject to the            SLVTRP3A.7     
C restrictions as set forth in the contract.                               SLVTRP3A.8     
C                                                                          SLVTRP3A.9     
C                Meteorological Office                                     SLVTRP3A.10    
C                London Road                                               SLVTRP3A.11    
C                BRACKNELL                                                 SLVTRP3A.12    
C                Berkshire UK                                              SLVTRP3A.13    
C                RG12 2SZ                                                  SLVTRP3A.14    
C                                                                          SLVTRP3A.15    
C If no contract has been raised with this copy of the code, the use,      SLVTRP3A.16    
C duplication or disclosure of it is strictly prohibited.  Permission      SLVTRP3A.17    
C to do so must first be obtained in writing from the Head of Numerical    SLVTRP3A.18    
C Modelling at the above address.                                          SLVTRP3A.19    
C ******************************COPYRIGHT******************************    SLVTRP3A.20    
C                                                                          SLVTRP3A.21    
!+ Subroutine to solve for mixed fluxes scattering without a matrix.       SLVTRP3A.22    
!                                                                          SLVTRP3A.23    
! Method:                                                                  SLVTRP3A.24    
!       Gaussian elimination in an upward direction is employed to         SLVTRP3A.25    
!       determine effective albedos for lower levels of the atmosphere.    SLVTRP3A.26    
!       This allows a downward pass of back-substitution to be carried     SLVTRP3A.27    
!       out to determine the upward and downward fluxes.                   SLVTRP3A.28    
!                                                                          SLVTRP3A.29    
! Current Owner of Code: J. M. Edwards                                     SLVTRP3A.30    
!                                                                          SLVTRP3A.31    
! History:                                                                 SLVTRP3A.32    
!       Version         Date                    Comment                    SLVTRP3A.33    
!       4.2             10-04-96                Original Code              SLVTRP3A.34    
!                                               (J. M. Edwards)            SLVTRP3A.35    
!  4.5  12/06/98  Fujitsu specific mod to split large loop to              GRB1F405.85    
!                 get longer vector length. R.Barnes@ecmwf.int             GRB1F405.86    
!                                                                          SLVTRP3A.36    
! Description of Code:                                                     SLVTRP3A.37    
!   FORTRAN 77  with extensions listed in documentation.                   SLVTRP3A.38    
!                                                                          SLVTRP3A.39    
!- ---------------------------------------------------------------------   SLVTRP3A.40    
      SUBROUTINE SOLVER_TRIPLE(N_PROFILE, N_LAYER, N_CLOUD_TOP             SLVTRP3A.41    
     &   , T, R, S_DOWN, S_UP                                              SLVTRP3A.42    
     &   , T_STRAT, R_STRAT, S_DOWN_STRAT, S_UP_STRAT                      SLVTRP3A.43    
     &   , T_CONV, R_CONV, S_DOWN_CONV, S_UP_CONV                          SLVTRP3A.44    
     &   , V11, V12, V13, V21, V22, V23, V31, V32, V33                     SLVTRP3A.45    
     &   , U11, U12, U13, U21, U22, U23, U31, U32, U33                     SLVTRP3A.46    
     &   , L_NET                                                           SLVTRP3A.47    
     &   , FLUX_INC_DOWN                                                   SLVTRP3A.48    
     &   , SOURCE_GROUND_FREE, SOURCE_GROUND_STRAT                         SLVTRP3A.49    
     &   , SOURCE_GROUND_CONV, ALBEDO_SURFACE_DIFF                         SLVTRP3A.50    
     &   , FLUX_TOTAL                                                      SLVTRP3A.51    
     &   , NPD_PROFILE, NPD_LAYER                                          SLVTRP3A.52    
     &   )                                                                 SLVTRP3A.53    
!                                                                          SLVTRP3A.54    
!                                                                          SLVTRP3A.55    
      IMPLICIT NONE                                                        SLVTRP3A.56    
!                                                                          SLVTRP3A.57    
!                                                                          SLVTRP3A.58    
!     SIZES OF DUMMY ARRAYS.                                               SLVTRP3A.59    
      INTEGER   !, INTENT(IN)                                              SLVTRP3A.60    
     &     NPD_PROFILE                                                     SLVTRP3A.61    
!             MAXIMUM NUMBER OF PROFILES                                   SLVTRP3A.62    
     &   , NPD_LAYER                                                       SLVTRP3A.63    
!             MAXIMUM NUMBER OF LAYERS                                     SLVTRP3A.64    
!                                                                          SLVTRP3A.65    
!                                                                          SLVTRP3A.66    
!     DUMMY ARGUMENTS.                                                     SLVTRP3A.67    
      INTEGER   !, INTENT(IN)                                              SLVTRP3A.68    
     &     N_PROFILE                                                       SLVTRP3A.69    
!             NUMBER OF PROFILES                                           SLVTRP3A.70    
     &   , N_LAYER                                                         SLVTRP3A.71    
!             NUMBER OF LAYERS                                             SLVTRP3A.72    
     &   , N_CLOUD_TOP                                                     SLVTRP3A.73    
!             TOPMOST CLOUDY LAYER                                         SLVTRP3A.74    
      LOGICAL   !, INTENT(IN)                                              SLVTRP3A.75    
     &     L_NET                                                           SLVTRP3A.76    
!             FLAG FOR CALCULATION OF NET FLUXES                           SLVTRP3A.77    
      REAL      !, INTENT(IN)                                              SLVTRP3A.78    
     &     T(NPD_PROFILE, NPD_LAYER)                                       SLVTRP3A.79    
!             CLEAR-SKY TRANSMISSION                                       SLVTRP3A.80    
     &   , R(NPD_PROFILE, NPD_LAYER)                                       SLVTRP3A.81    
!             CLEAR-SKY REFLECTION                                         SLVTRP3A.82    
     &   , S_DOWN(NPD_PROFILE, NPD_LAYER)                                  SLVTRP3A.83    
!             CLEAR-SKY DOWNWARD SOURCE FUNCTION                           SLVTRP3A.84    
     &   , S_UP(NPD_PROFILE, NPD_LAYER)                                    SLVTRP3A.85    
!             CLEAR-SKY UPWARD SOURCE FUNCTION                             SLVTRP3A.86    
     &   , T_STRAT(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.87    
!             STRATFIFORM TRANSMISSION                                     SLVTRP3A.88    
     &   , R_STRAT(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.89    
!             STRATFIFORM REFLECTION                                       SLVTRP3A.90    
     &   , S_DOWN_STRAT(NPD_PROFILE, NPD_LAYER)                            SLVTRP3A.91    
!             DOWNWARD STRATFIFORM SOURCE FUNCTION                         SLVTRP3A.92    
     &   , S_UP_STRAT(NPD_PROFILE, NPD_LAYER)                              SLVTRP3A.93    
!             UPWARD STRATFIFORM SOURCE FUNCTION                           SLVTRP3A.94    
     &   , T_CONV(NPD_PROFILE, NPD_LAYER)                                  SLVTRP3A.95    
!             CONVECTIVE TRANSMISSION                                      SLVTRP3A.96    
     &   , R_CONV(NPD_PROFILE, NPD_LAYER)                                  SLVTRP3A.97    
!             CONVECTIVE REFLECTION                                        SLVTRP3A.98    
     &   , S_DOWN_CONV(NPD_PROFILE, NPD_LAYER)                             SLVTRP3A.99    
!             DOWNWARD CONVECTIVE SOURCE FUNCTION                          SLVTRP3A.100   
     &   , S_UP_CONV(NPD_PROFILE, NPD_LAYER)                               SLVTRP3A.101   
!             UPWARD CONVECTIVE SOURCE FUNCTION                            SLVTRP3A.102   
      REAL      !, INTENT(IN)                                              SLVTRP3A.103   
     &     V11(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.104   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.105   
     &   , V12(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.106   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.107   
     &   , V13(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.108   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.109   
     &   , V21(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.110   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.111   
     &   , V22(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.112   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.113   
     &   , V23(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.114   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.115   
     &   , V31(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.116   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.117   
     &   , V32(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.118   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.119   
     &   , V33(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.120   
!             ENERGY TRANSFER COEFFICIENT FOR DOWNWARD RADIATION           SLVTRP3A.121   
      REAL                                                                 SLVTRP3A.122   
     &     U11(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.123   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.124   
     &   , U12(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.125   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.126   
     &   , U13(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.127   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.128   
     &   , U21(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.129   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.130   
     &   , U22(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.131   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.132   
     &   , U23(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.133   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.134   
     &   , U31(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.135   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.136   
     &   , U32(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.137   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.138   
     &   , U33(NPD_PROFILE, 0: NPD_LAYER)                                  SLVTRP3A.139   
!             ENERGY TRANSFER COEFFICIENT FOR UPWARD RADIATION             SLVTRP3A.140   
      REAL      !, INTENT(IN)                                              SLVTRP3A.141   
     &     FLUX_INC_DOWN(NPD_PROFILE)                                      SLVTRP3A.142   
!             INCIDENT FLUX                                                SLVTRP3A.143   
     &   , SOURCE_GROUND_FREE(NPD_PROFILE)                                 SLVTRP3A.144   
!             SOURCE FROM GROUND (CLEAR SKY)                               SLVTRP3A.145   
     &   , SOURCE_GROUND_STRAT(NPD_PROFILE)                                SLVTRP3A.146   
!             SOURCE FROM GROUND (CLOUDY REGION)                           SLVTRP3A.147   
     &   , SOURCE_GROUND_CONV(NPD_PROFILE)                                 SLVTRP3A.148   
!             SOURCE FROM GROUND (CLOUDY REGION)                           SLVTRP3A.149   
     &   , ALBEDO_SURFACE_DIFF(NPD_PROFILE)                                SLVTRP3A.150   
!             DIFFUSE ALBEDO                                               SLVTRP3A.151   
      REAL      !, INTENT(OUT)                                             SLVTRP3A.152   
     &     FLUX_TOTAL(NPD_PROFILE, 2*NPD_LAYER+2)                          SLVTRP3A.153   
!             TOTAL FLUX                                                   SLVTRP3A.154   
!                                                                          SLVTRP3A.155   
!     LOCAL VARIABLES.                                                     SLVTRP3A.156   
      INTEGER                                                              SLVTRP3A.157   
     &     I                                                               SLVTRP3A.158   
!             LOOP VARIABLE                                                SLVTRP3A.159   
     &   , L                                                               SLVTRP3A.160   
!             LOOP VARIABLE                                                SLVTRP3A.161   
!                                                                          SLVTRP3A.162   
!     EFFECTIVE COUPLING ALBEDOS AND SOURCE FUNCTIONS:                     SLVTRP3A.163   
      REAL                                                                 SLVTRP3A.164   
     &     ALPHA11(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.165   
     &   , ALPHA12(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.166   
     &   , ALPHA13(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.167   
     &   , ALPHA21(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.168   
     &   , ALPHA22(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.169   
     &   , ALPHA23(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.170   
     &   , ALPHA31(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.171   
     &   , ALPHA32(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.172   
     &   , ALPHA33(NPD_PROFILE, NPD_LAYER+1)                               SLVTRP3A.173   
     &   , G1(NPD_PROFILE, NPD_LAYER+1)                                    SLVTRP3A.174   
     &   , G2(NPD_PROFILE, NPD_LAYER+1)                                    SLVTRP3A.175   
     &   , G3(NPD_PROFILE, NPD_LAYER+1)                                    SLVTRP3A.176   
!     TERMS FOR DOWNWARD PROPAGATION:                                      SLVTRP3A.177   
      REAL                                                                 SLVTRP3A.178   
     &     GAMMA11(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.179   
     &   , GAMMA12(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.180   
     &   , GAMMA13(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.181   
     &   , GAMMA21(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.182   
     &   , GAMMA22(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.183   
     &   , GAMMA23(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.184   
     &   , GAMMA31(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.185   
     &   , GAMMA32(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.186   
     &   , GAMMA33(NPD_PROFILE, NPD_LAYER)                                 SLVTRP3A.187   
     &   , BETA11_INV(NPD_PROFILE, NPD_LAYER)                              SLVTRP3A.188   
     &   , BETA21(NPD_PROFILE, NPD_LAYER)                                  SLVTRP3A.189   
     &   , BETA22_INV(NPD_PROFILE, NPD_LAYER)                              SLVTRP3A.190   
     &   , BETA31(NPD_PROFILE, NPD_LAYER)                                  SLVTRP3A.191   
     &   , BETA32(NPD_PROFILE, NPD_LAYER)                                  SLVTRP3A.192   
     &   , BETA33_INV(NPD_PROFILE, NPD_LAYER)                              SLVTRP3A.193   
     &   , H1(NPD_PROFILE, NPD_LAYER)                                      SLVTRP3A.194   
     &   , H2(NPD_PROFILE, NPD_LAYER)                                      SLVTRP3A.195   
     &   , H3(NPD_PROFILE, NPD_LAYER)                                      SLVTRP3A.196   
!                                                                          SLVTRP3A.197   
!     AUXILAIRY NUMERICAL VARIABLES REQUIRED ONLY IN THE CURRENT LAYER:    SLVTRP3A.198   
      REAL                                                                 SLVTRP3A.199   
     &     THETA11                                                         SLVTRP3A.200   
     &   , THETA12                                                         SLVTRP3A.201   
     &   , THETA13                                                         SLVTRP3A.202   
     &   , THETA21                                                         SLVTRP3A.203   
     &   , THETA22                                                         SLVTRP3A.204   
     &   , THETA23                                                         SLVTRP3A.205   
     &   , THETA31                                                         SLVTRP3A.206   
     &   , THETA32                                                         SLVTRP3A.207   
     &   , THETA33                                                         SLVTRP3A.208   
     &   , LAMBDA3                                                         SLVTRP3A.209   
     &   , LAMBDA2                                                         SLVTRP3A.210   
     &   , LAMBDA1                                                         SLVTRP3A.211   
     &   , LAMBDA                                                          SLVTRP3A.212   
!                                                                          SLVTRP3A.213   
!     TEMPORARY FLUXES                                                     SLVTRP3A.214   
      REAL                                                                 SLVTRP3A.215   
     &     FLUX_DOWN_1(NPD_PROFILE, 0: NPD_LAYER)                          SLVTRP3A.216   
!             DOWNWARD FLUXES OUTSIDE CLOUDS JUST BELOW I'TH LEVEL         SLVTRP3A.217   
     &   , FLUX_DOWN_2(NPD_PROFILE, 0: NPD_LAYER)                          SLVTRP3A.218   
!             DOWNWARD FLUXES INSIDE CLOUDS JUST BELOW I'TH LEVEL          SLVTRP3A.219   
     &   , FLUX_DOWN_3(NPD_PROFILE, 0: NPD_LAYER)                          SLVTRP3A.220   
!             DOWNWARD FLUXES INSIDE CLOUDS JUST BELOW I'TH LEVEL          SLVTRP3A.221   
     &   , FLUX_UP_1(NPD_PROFILE, 0: NPD_LAYER)                            SLVTRP3A.222   
!             UPWARD FLUXES OUTSIDE CLOUDS JUST ABOVE I'TH LEVEL           SLVTRP3A.223   
     &   , FLUX_UP_2(NPD_PROFILE, 0: NPD_LAYER)                            SLVTRP3A.224   
!             UPWARD FLUXES INSIDE CLOUDS JUST ABOVE I'TH LEVEL            SLVTRP3A.225   
     &   , FLUX_UP_3(NPD_PROFILE, 0: NPD_LAYER)                            SLVTRP3A.226   
!             UPWARD FLUXES INSIDE CLOUDS JUST ABOVE I'TH LEVEL            SLVTRP3A.227   
!                                                                          SLVTRP3A.228   
!                                                                          SLVTRP3A.229   
!                                                                          SLVTRP3A.230   
!     THIS ROUTINE IS SPECIFIC TO CASES OF THREE REGIONS AND IT IS         SLVTRP3A.231   
!     ASSUMED THAT 1 REPRESENTS CLEAR SKIES, 2 REPRESENTS STARTIFORM       SLVTRP3A.232   
!     CLOUDS AND 3 REPRESENTS CONVECTIVE CLOUD.                            SLVTRP3A.233   
!                                                                          SLVTRP3A.234   
!     INITIALIZE AT THE BOTTOM OF THE COLUMN FOR UPWARD ELIMINATION.       SLVTRP3A.235   
      DO L=1, N_PROFILE                                                    SLVTRP3A.236   
         ALPHA11(L, N_LAYER+1)=ALBEDO_SURFACE_DIFF(L)                      SLVTRP3A.237   
         ALPHA12(L, N_LAYER+1)=0.0E+00                                     SLVTRP3A.238   
         ALPHA13(L, N_LAYER+1)=0.0E+00                                     SLVTRP3A.239   
         ALPHA21(L, N_LAYER+1)=0.0E+00                                     SLVTRP3A.240   
         ALPHA22(L, N_LAYER+1)=ALBEDO_SURFACE_DIFF(L)                      SLVTRP3A.241   
         ALPHA23(L, N_LAYER+1)=0.0E+00                                     SLVTRP3A.242   
         ALPHA31(L, N_LAYER+1)=0.0E+00                                     SLVTRP3A.243   
         ALPHA32(L, N_LAYER+1)=0.0E+00                                     SLVTRP3A.244   
         ALPHA33(L, N_LAYER+1)=ALBEDO_SURFACE_DIFF(L)                      SLVTRP3A.245   
         G1(L, N_LAYER+1)=SOURCE_GROUND_FREE(L)                            SLVTRP3A.246   
         G2(L, N_LAYER+1)=SOURCE_GROUND_STRAT(L)                           SLVTRP3A.247   
         G3(L, N_LAYER+1)=SOURCE_GROUND_CONV(L)                            SLVTRP3A.248   
      ENDDO                                                                SLVTRP3A.249   
!                                                                          SLVTRP3A.250   
!     UPWARD ELIMINATION THROUGH THE CLOUDY LAYERS.                        SLVTRP3A.251   
      DO I=N_LAYER, N_CLOUD_TOP, -1                                        SLVTRP3A.252   
         DO L=1, N_PROFILE                                                 SLVTRP3A.253   
!                                                                          SLVTRP3A.254   
            THETA11=ALPHA11(L, I+1)*V11(L, I)+ALPHA12(L, I+1)*V21(L, I)    SLVTRP3A.255   
     &         +ALPHA13(L, I+1)*V31(L, I)                                  SLVTRP3A.256   
            THETA12=ALPHA11(L, I+1)*V12(L, I)+ALPHA12(L, I+1)*V22(L, I)    SLVTRP3A.257   
     &         +ALPHA13(L, I+1)*V32(L, I)                                  SLVTRP3A.258   
            THETA13=ALPHA11(L, I+1)*V13(L, I)+ALPHA12(L, I+1)*V23(L, I)    SLVTRP3A.259   
     &         +ALPHA13(L, I+1)*V33(L, I)                                  SLVTRP3A.260   
            THETA21=ALPHA21(L, I+1)*V11(L, I)+ALPHA22(L, I+1)*V21(L, I)    SLVTRP3A.261   
     &         +ALPHA23(L, I+1)*V31(L, I)                                  SLVTRP3A.262   
            THETA22=ALPHA21(L, I+1)*V12(L, I)+ALPHA22(L, I+1)*V22(L, I)    SLVTRP3A.263   
     &         +ALPHA23(L, I+1)*V32(L, I)                                  SLVTRP3A.264   
            THETA23=ALPHA21(L, I+1)*V13(L, I)+ALPHA22(L, I+1)*V23(L, I)    SLVTRP3A.265   
     &         +ALPHA23(L, I+1)*V33(L, I)                                  SLVTRP3A.266   
            THETA31=ALPHA31(L, I+1)*V11(L, I)+ALPHA32(L, I+1)*V21(L, I)    SLVTRP3A.267   
     &         +ALPHA33(L, I+1)*V31(L, I)                                  SLVTRP3A.268   
            THETA32=ALPHA31(L, I+1)*V12(L, I)+ALPHA32(L, I+1)*V22(L, I)    SLVTRP3A.269   
     &         +ALPHA33(L, I+1)*V32(L, I)                                  SLVTRP3A.270   
            THETA33=ALPHA31(L, I+1)*V13(L, I)+ALPHA32(L, I+1)*V23(L, I)    SLVTRP3A.271   
     &         +ALPHA33(L, I+1)*V33(L, I)                                  SLVTRP3A.272   
                                                                           SLVTRP3A.273   
            BETA31(L, I)=-THETA31*R(L, I)                                  SLVTRP3A.274   
            BETA32(L, I)=-THETA32*R_STRAT(L, I)                            SLVTRP3A.275   
            BETA33_INV(L, I)=1.0E+00/(1.0E+00-THETA33*R_CONV(L, I))        SLVTRP3A.276   
            GAMMA31(L, I)=THETA31*T(L, I)                                  SLVTRP3A.277   
            GAMMA32(L, I)=THETA32*T_STRAT(L, I)                            SLVTRP3A.278   
            GAMMA33(L, I)=THETA33*T_CONV(L, I)                             SLVTRP3A.279   
            H3(L, I)=G3(L, I+1)+THETA31*S_DOWN(L, I)                       SLVTRP3A.280   
     &         +THETA32*S_DOWN_STRAT(L, I)                                 SLVTRP3A.281   
     &         +THETA33*S_DOWN_CONV(L, I)                                  SLVTRP3A.282   
!                                                                          SLVTRP3A.283   
            LAMBDA3=THETA23*R_CONV(L, I)*BETA33_INV(L, I)                  SLVTRP3A.284   
            BETA22_INV(L, I)=1.0E+00                                       SLVTRP3A.285   
     &         /(1.0E+00-THETA22*R_STRAT(L, I)+LAMBDA3*BETA32(L, I))       SLVTRP3A.286   
            BETA21(L, I)=-THETA21*R(L, I)+LAMBDA3*BETA31(L, I)             SLVTRP3A.287   
            GAMMA21(L, I)=THETA21*T(L, I)+LAMBDA3*GAMMA31(L, I)            SLVTRP3A.288   
            GAMMA22(L, I)=THETA22*T_STRAT(L, I)+LAMBDA3*GAMMA32(L, I)      SLVTRP3A.289   
            GAMMA23(L, I)=THETA23*T_CONV(L, I)+LAMBDA3*GAMMA33(L, I)       SLVTRP3A.290   
            H2(L, I)=G2(L, I+1)+THETA21*S_DOWN(L, I)                       SLVTRP3A.291   
     &         +THETA22*S_DOWN_STRAT(L, I)+THETA23*S_DOWN_CONV(L, I)       SLVTRP3A.292   
     &         +LAMBDA3*H3(L, I)                                           SLVTRP3A.293   
!                                                                          SLVTRP3A.294   
            LAMBDA3=THETA13*R_CONV(L, I)*BETA33_INV(L, I)                  SLVTRP3A.295   
            LAMBDA2=(THETA12*R_STRAT(L, I)-LAMBDA3*BETA32(L, I))           SLVTRP3A.296   
     &         *BETA22_INV(L, I)                                           SLVTRP3A.297   
            BETA11_INV(L, I)=1.0E+00                                       SLVTRP3A.298   
     &         /(1.0E+00-THETA11*R(L, I)+LAMBDA3*BETA31(L, I)              SLVTRP3A.299   
     &         +LAMBDA2*BETA21(L, I))                                      SLVTRP3A.300   
            GAMMA11(L, I)=THETA11*T(L, I)+LAMBDA3*GAMMA31(L, I)            SLVTRP3A.301   
     &         +LAMBDA2*GAMMA21(L, I)                                      SLVTRP3A.302   
            GAMMA12(L, I)=THETA12*T_STRAT(L, I)+LAMBDA3*GAMMA32(L, I)      SLVTRP3A.303   
     &         +LAMBDA2*GAMMA22(L, I)                                      SLVTRP3A.304   
            GAMMA13(L, I)=THETA13*T_CONV(L, I)+LAMBDA3*GAMMA33(L, I)       SLVTRP3A.305   
     &         +LAMBDA2*GAMMA23(L, I)                                      SLVTRP3A.306   
            H1(L, I)=G1(L, I+1)+THETA11*S_DOWN(L, I)                       SLVTRP3A.307   
     &         +THETA12*S_DOWN_STRAT(L, I)+THETA13*S_DOWN_CONV(L, I)       SLVTRP3A.308   
     &         +LAMBDA3*H3(L, I)+LAMBDA2*H2(L, I)                          SLVTRP3A.309   
*IF DEF,FUJITSU                                                            GRB1F405.87    
         END DO                                                            GRB1F405.88    
                                                                           SLVTRP3A.310   
!                                                                          SLVTRP3A.311   
! Large loop split here to get longer vector lengths on VPP700             GRB1F405.89    
         DO L=1, N_PROFILE                                                 GRB1F405.90    
*ENDIF                                                                     GRB1F405.91    
            LAMBDA3=U33(L, I-1)*T_CONV(L, I)*BETA33_INV(L, I)              SLVTRP3A.312   
            LAMBDA2=(U32(L, I-1)*T_STRAT(L, I)+LAMBDA3*BETA32(L, I))       SLVTRP3A.313   
     &         *BETA22_INV(L, I)                                           SLVTRP3A.314   
            LAMBDA1=(U31(L, I-1)*T(L, I)+LAMBDA3*BETA31(L, I)              SLVTRP3A.315   
     &         +LAMBDA2*BETA21(L, I))*BETA11_INV(L, I)                     SLVTRP3A.316   
            ALPHA31(L, I)=U31(L, I-1)*R(L, I)+LAMBDA3*GAMMA31(L, I)        SLVTRP3A.317   
     &         +LAMBDA2*GAMMA21(L, I)+LAMBDA1*GAMMA11(L, I)                SLVTRP3A.318   
            ALPHA32(L, I)=U32(L, I-1)*R_STRAT(L, I)                        SLVTRP3A.319   
     &         +LAMBDA3*GAMMA32(L, I)+LAMBDA2*GAMMA22(L, I)                SLVTRP3A.320   
     &         +LAMBDA1*GAMMA12(L, I)                                      SLVTRP3A.321   
            ALPHA33(L, I)=U33(L, I-1)*R_CONV(L, I)                         SLVTRP3A.322   
     &         +LAMBDA3*GAMMA33(L, I)+LAMBDA2*GAMMA23(L, I)                SLVTRP3A.323   
     &         +LAMBDA1*GAMMA13(L, I)                                      SLVTRP3A.324   
            G3(L, I)=U31(L, I-1)*S_UP(L, I)+U32(L, I-1)*S_UP_STRAT(L, I)   SLVTRP3A.325   
     &         +U33(L, I-1)*S_UP_CONV(L, I)                                SLVTRP3A.326   
     &         +LAMBDA3*H3(L, I)+LAMBDA2*H2(L, I)+LAMBDA1*H1(L, I)         SLVTRP3A.327   
!                                                                          SLVTRP3A.328   
            LAMBDA3=U23(L, I-1)*T_CONV(L, I)*BETA33_INV(L, I)              SLVTRP3A.329   
            LAMBDA2=(U22(L, I-1)*T_STRAT(L, I)+LAMBDA3*BETA32(L, I))       SLVTRP3A.330   
     &         *BETA22_INV(L, I)                                           SLVTRP3A.331   
            LAMBDA1=(U21(L, I-1)*T(L, I)+LAMBDA3*BETA31(L, I)              SLVTRP3A.332   
     &         +LAMBDA2*BETA21(L, I))*BETA11_INV(L, I)                     SLVTRP3A.333   
            ALPHA21(L, I)=U21(L, I-1)*R(L, I)+LAMBDA3*GAMMA31(L, I)        SLVTRP3A.334   
     &         +LAMBDA2*GAMMA21(L, I)+LAMBDA1*GAMMA11(L, I)                SLVTRP3A.335   
            ALPHA22(L, I)=U22(L, I-1)*R_STRAT(L, I)                        SLVTRP3A.336   
     &         +LAMBDA3*GAMMA32(L, I)+LAMBDA2*GAMMA22(L, I)                SLVTRP3A.337   
     &         +LAMBDA1*GAMMA12(L, I)                                      SLVTRP3A.338   
            ALPHA23(L, I)=U23(L, I-1)*R_CONV(L, I)                         SLVTRP3A.339   
     &         +LAMBDA3*GAMMA33(L, I)+LAMBDA2*GAMMA23(L, I)                SLVTRP3A.340   
     &         +LAMBDA1*GAMMA13(L, I)                                      SLVTRP3A.341   
            G2(L, I)=U21(L, I-1)*S_UP(L, I)+U22(L, I-1)*S_UP_STRAT(L, I)   SLVTRP3A.342   
     &         +U23(L, I-1)*S_UP_CONV(L, I)                                SLVTRP3A.343   
     &         +LAMBDA3*H3(L, I)+LAMBDA2*H2(L, I)+LAMBDA1*H1(L, I)         SLVTRP3A.344   
!                                                                          SLVTRP3A.345   
            LAMBDA3=U13(L, I-1)*T_CONV(L, I)*BETA33_INV(L, I)              SLVTRP3A.346   
            LAMBDA2=(U12(L, I-1)*T_STRAT(L, I)+LAMBDA3*BETA32(L, I))       SLVTRP3A.347   
     &         *BETA22_INV(L, I)                                           SLVTRP3A.348   
            LAMBDA1=(U11(L, I-1)*T(L, I)+LAMBDA3*BETA31(L, I)              SLVTRP3A.349   
     &         +LAMBDA2*BETA21(L, I))*BETA11_INV(L, I)                     SLVTRP3A.350   
            ALPHA11(L, I)=U11(L, I-1)*R(L, I)+LAMBDA3*GAMMA31(L, I)        SLVTRP3A.351   
     &         +LAMBDA2*GAMMA21(L, I)+LAMBDA1*GAMMA11(L, I)                SLVTRP3A.352   
            ALPHA12(L, I)=U12(L, I-1)*R_STRAT(L, I)                        SLVTRP3A.353   
     &         +LAMBDA3*GAMMA32(L, I)+LAMBDA2*GAMMA22(L, I)                SLVTRP3A.354   
     &         +LAMBDA1*GAMMA12(L, I)                                      SLVTRP3A.355   
            ALPHA13(L, I)=U13(L, I-1)*R_CONV(L, I)                         SLVTRP3A.356   
     &         +LAMBDA3*GAMMA33(L, I)+LAMBDA2*GAMMA23(L, I)                SLVTRP3A.357   
     &         +LAMBDA1*GAMMA13(L, I)                                      SLVTRP3A.358   
            G1(L, I)=U11(L, I-1)*S_UP(L, I)+U12(L, I-1)*S_UP_STRAT(L, I)   SLVTRP3A.359   
     &         +U13(L, I-1)*S_UP_CONV(L, I)                                SLVTRP3A.360   
     &         +LAMBDA3*H3(L, I)+LAMBDA2*H2(L, I)+LAMBDA1*H1(L, I)         SLVTRP3A.361   
!                                                                          SLVTRP3A.362   
         ENDDO                                                             SLVTRP3A.363   
      ENDDO                                                                SLVTRP3A.364   
!                                                                          SLVTRP3A.365   
!     THE LAYER ABOVE THE CLOUD: ONLY ONE SET OF ALPHAS IS NOW NEEDED.     SLVTRP3A.366   
!                                                                          SLVTRP3A.367   
      I=N_CLOUD_TOP-1                                                      SLVTRP3A.368   
      DO L=1, N_PROFILE                                                    SLVTRP3A.369   
!                                                                          SLVTRP3A.370   
         IF (N_CLOUD_TOP.LT.N_LAYER) THEN                                  SLVTRP3A.371   
!           IF THERE IS NO CLOUD IN THE COLUMN THE V'S WILL NOT BE         SLVTRP3A.372   
!           ASSIGNED SO AN IF TEST IS REQUIRED.                            SLVTRP3A.373   
            THETA11=ALPHA11(L, I+1)*V11(L, I)+ALPHA12(L, I+1)*V21(L, I)    SLVTRP3A.374   
     &         +ALPHA13(L, I+1)*V31(L, I)                                  SLVTRP3A.375   
         ELSE                                                              SLVTRP3A.376   
            THETA11=ALPHA11(L, I+1)                                        SLVTRP3A.377   
         ENDIF                                                             SLVTRP3A.378   
!                                                                          SLVTRP3A.379   
         BETA11_INV(L, I)=1.0E+00/(1.0E+00-THETA11*R(L, I))                SLVTRP3A.380   
         GAMMA11(L, I)=THETA11*T(L, I)                                     SLVTRP3A.381   
         H1(L, I)=G1(L, I+1)+THETA11*S_DOWN(L, I)                          SLVTRP3A.382   
!                                                                          SLVTRP3A.383   
         LAMBDA=T(L, I)*BETA11_INV(L, I)                                   SLVTRP3A.384   
         ALPHA11(L, I)=R(L, I)+LAMBDA*GAMMA11(L, I)                        SLVTRP3A.385   
         G1(L, I)=S_UP(L, I)+LAMBDA*H1(L, I)                               SLVTRP3A.386   
!                                                                          SLVTRP3A.387   
      ENDDO                                                                SLVTRP3A.388   
!                                                                          SLVTRP3A.389   
      DO I=N_CLOUD_TOP-2, 1, -1                                            SLVTRP3A.390   
         DO L=1, N_PROFILE                                                 SLVTRP3A.391   
!                                                                          SLVTRP3A.392   
            BETA11_INV(L, I)=1.0E+00/(1.0E+00-ALPHA11(L, I+1)*R(L, I))     SLVTRP3A.393   
            GAMMA11(L, I)=ALPHA11(L, I+1)*T(L, I)                          SLVTRP3A.394   
            H1(L, I)=G1(L, I+1)+ALPHA11(L, I+1)*S_DOWN(L, I)               SLVTRP3A.395   
!                                                                          SLVTRP3A.396   
            LAMBDA1=T(L, I)*BETA11_INV(L, I)                               SLVTRP3A.397   
            ALPHA11(L, I)=R(L, I)+LAMBDA1*GAMMA11(L, I)                    SLVTRP3A.398   
            G1(L, I)=S_UP(L, I)+LAMBDA1*H1(L, I)                           SLVTRP3A.399   
!                                                                          SLVTRP3A.400   
         ENDDO                                                             SLVTRP3A.401   
      ENDDO                                                                SLVTRP3A.402   
!                                                                          SLVTRP3A.403   
!                                                                          SLVTRP3A.404   
!     INITIALIZE FOR DOWNWARD BACK-SUBSTITUTION.                           SLVTRP3A.405   
      DO L=1, N_PROFILE                                                    SLVTRP3A.406   
         FLUX_TOTAL(L, 2)=FLUX_INC_DOWN(L)                                 SLVTRP3A.407   
         FLUX_TOTAL(L, 1)=ALPHA11(L, 1)*FLUX_TOTAL(L, 2)+G1(L, 1)          SLVTRP3A.408   
      ENDDO                                                                SLVTRP3A.409   
!                                                                          SLVTRP3A.410   
!     SWEEP DOWNWARD THROUGH THE CLEAR-SKY REGION, FINDING THE DOWNWARD    SLVTRP3A.411   
!     FLUX AT THE TOP OF THE LAYER AND THE UPWARD FLUX AT THE BOTTOM.      SLVTRP3A.412   
      DO I=1, N_CLOUD_TOP-1                                                SLVTRP3A.413   
         DO L=1, N_PROFILE                                                 SLVTRP3A.414   
            FLUX_TOTAL(L, 2*I+1)=(GAMMA11(L, I)*FLUX_TOTAL(L, 2*I)         SLVTRP3A.415   
     &         +H1(L, I))*BETA11_INV(L, I)                                 SLVTRP3A.416   
            FLUX_TOTAL(L, 2*I+2)=T(L, I)*FLUX_TOTAL(L, 2*I)                SLVTRP3A.417   
     &         +R(L, I)*FLUX_TOTAL(L, 2*I+1)+S_DOWN(L, I)                  SLVTRP3A.418   
         ENDDO                                                             SLVTRP3A.419   
      ENDDO                                                                SLVTRP3A.420   
!                                                                          SLVTRP3A.421   
!     PASS INTO THE TOP CLOUDY LAYER. USE FLUX_DOWN_[1,2,3] TO HOLD,       SLVTRP3A.422   
!     PROVISIONALLY, THE DOWNWARD FLUXES JUST BELOW THE TOP OF THE         SLVTRP3A.423   
!     LAYER, THEN CALCULATE THE UPWARD FLUXES AT THE BOTTOM AND            SLVTRP3A.424   
!     FINALLY THE DOWNWARD FLUXES AT THE BOTTOM OF THE LAYER.              SLVTRP3A.425   
      I=N_CLOUD_TOP                                                        SLVTRP3A.426   
      DO L=1, N_PROFILE                                                    SLVTRP3A.427   
         FLUX_DOWN_1(L, I)=V11(L, I-1)*FLUX_TOTAL(L, 2*I)                  SLVTRP3A.428   
         FLUX_DOWN_2(L, I)=V21(L, I-1)*FLUX_TOTAL(L, 2*I)                  SLVTRP3A.429   
         FLUX_DOWN_3(L, I)=V31(L, I-1)*FLUX_TOTAL(L, 2*I)                  SLVTRP3A.430   
         FLUX_UP_1(L, I)=(GAMMA11(L, I)*FLUX_DOWN_1(L, I)                  SLVTRP3A.431   
     &      +GAMMA12(L, I)*FLUX_DOWN_2(L, I)                               SLVTRP3A.432   
     &      +GAMMA13(L, I)*FLUX_DOWN_3(L, I)                               SLVTRP3A.433   
     &      +H1(L, I))*BETA11_INV(L, I)                                    SLVTRP3A.434   
         FLUX_UP_2(L, I)=(GAMMA21(L, I)*FLUX_DOWN_1(L, I)                  SLVTRP3A.435   
     &      +GAMMA22(L, I)*FLUX_DOWN_2(L, I)                               SLVTRP3A.436   
     &      +GAMMA23(L, I)*FLUX_DOWN_3(L, I)+H2(L, I)                      SLVTRP3A.437   
     &      -BETA21(L, I)*FLUX_UP_1(L, I))*BETA22_INV(L, I)                SLVTRP3A.438   
         FLUX_UP_3(L, I)=(GAMMA31(L, I)*FLUX_DOWN_1(L, I)                  SLVTRP3A.439   
     &      +GAMMA32(L, I)*FLUX_DOWN_2(L, I)                               SLVTRP3A.440   
     &      +GAMMA33(L, I)*FLUX_DOWN_3(L, I)+H3(L, I)                      SLVTRP3A.441   
     &      -BETA31(L, I)*FLUX_UP_1(L, I)-BETA32(L, I)*FLUX_UP_2(L, I))    SLVTRP3A.442   
     &      *BETA33_INV(L, I)                                              SLVTRP3A.443   
         FLUX_DOWN_1(L, I)=T(L, I)*FLUX_DOWN_1(L, I)                       SLVTRP3A.444   
     &      +R(L, I)*FLUX_UP_1(L, I)+S_DOWN(L, I)                          SLVTRP3A.445   
         FLUX_DOWN_2(L, I)=T_STRAT(L, I)*FLUX_DOWN_2(L, I)                 SLVTRP3A.446   
     &      +R_STRAT(L, I)*FLUX_UP_2(L, I)+S_DOWN_STRAT(L, I)              SLVTRP3A.447   
         FLUX_DOWN_3(L, I)=T_CONV(L, I)*FLUX_DOWN_3(L, I)                  SLVTRP3A.448   
     &      +R_CONV(L, I)*FLUX_UP_3(L, I)+S_DOWN_CONV(L, I)                SLVTRP3A.449   
      ENDDO                                                                SLVTRP3A.450   
!                                                                          SLVTRP3A.451   
!     THE MAIN LOOP OF BACK-SUBSTITUTION. THE PROVISIONAL USE OF THE       SLVTRP3A.452   
!     DOWNWARD FLUXES IS AS ABOVE.                                         SLVTRP3A.453   
      DO I=N_CLOUD_TOP+1, N_LAYER                                          SLVTRP3A.454   
         DO L=1, N_PROFILE                                                 SLVTRP3A.455   
            FLUX_DOWN_1(L, I)=V11(L, I-1)*FLUX_DOWN_1(L, I-1)              SLVTRP3A.456   
     &         +V12(L, I-1)*FLUX_DOWN_2(L, I-1)                            SLVTRP3A.457   
     &         +V13(L, I-1)*FLUX_DOWN_3(L, I-1)                            SLVTRP3A.458   
            FLUX_DOWN_2(L, I)=V21(L, I-1)*FLUX_DOWN_1(L, I-1)              SLVTRP3A.459   
     &         +V22(L, I-1)*FLUX_DOWN_2(L, I-1)                            SLVTRP3A.460   
     &         +V23(L, I-1)*FLUX_DOWN_3(L, I-1)                            SLVTRP3A.461   
            FLUX_DOWN_3(L, I)=V31(L, I-1)*FLUX_DOWN_1(L, I-1)              SLVTRP3A.462   
     &         +V32(L, I-1)*FLUX_DOWN_2(L, I-1)                            SLVTRP3A.463   
     &         +V33(L, I-1)*FLUX_DOWN_3(L, I-1)                            SLVTRP3A.464   
            FLUX_UP_1(L, I)=(GAMMA11(L, I)*FLUX_DOWN_1(L, I)               SLVTRP3A.465   
     &         +GAMMA12(L, I)*FLUX_DOWN_2(L, I)                            SLVTRP3A.466   
     &         +GAMMA13(L, I)*FLUX_DOWN_3(L, I)                            SLVTRP3A.467   
     &         +H1(L, I))*BETA11_INV(L, I)                                 SLVTRP3A.468   
            FLUX_UP_2(L, I)=(GAMMA21(L, I)*FLUX_DOWN_1(L, I)               SLVTRP3A.469   
     &         +GAMMA22(L, I)*FLUX_DOWN_2(L, I)                            SLVTRP3A.470   
     &         +GAMMA23(L, I)*FLUX_DOWN_3(L, I)+H2(L, I)                   SLVTRP3A.471   
     &         -BETA21(L, I)*FLUX_UP_1(L, I))*BETA22_INV(L, I)             SLVTRP3A.472   
            FLUX_UP_3(L, I)=(GAMMA31(L, I)*FLUX_DOWN_1(L, I)               SLVTRP3A.473   
     &         +GAMMA32(L, I)*FLUX_DOWN_2(L, I)                            SLVTRP3A.474   
     &         +GAMMA33(L, I)*FLUX_DOWN_3(L, I)+H3(L, I)                   SLVTRP3A.475   
     &         -BETA31(L, I)*FLUX_UP_1(L, I)                               SLVTRP3A.476   
     &         -BETA32(L, I)*FLUX_UP_2(L, I))                              SLVTRP3A.477   
     &         *BETA33_INV(L, I)                                           SLVTRP3A.478   
            FLUX_DOWN_1(L, I)=T(L, I)*FLUX_DOWN_1(L, I)                    SLVTRP3A.479   
     &         +R(L, I)*FLUX_UP_1(L, I)+S_DOWN(L, I)                       SLVTRP3A.480   
            FLUX_DOWN_2(L, I)=T_STRAT(L, I)*FLUX_DOWN_2(L, I)              SLVTRP3A.481   
     &         +R_STRAT(L, I)*FLUX_UP_2(L, I)+S_DOWN_STRAT(L, I)           SLVTRP3A.482   
            FLUX_DOWN_3(L, I)=T_CONV(L, I)*FLUX_DOWN_3(L, I)               SLVTRP3A.483   
     &         +R_CONV(L, I)*FLUX_UP_3(L, I)+S_DOWN_CONV(L, I)             SLVTRP3A.484   
         ENDDO                                                             SLVTRP3A.485   
      ENDDO                                                                SLVTRP3A.486   
!                                                                          SLVTRP3A.487   
!                                                                          SLVTRP3A.488   
!     CALCULATE THE OVERALL FLUX.                                          SLVTRP3A.489   
      DO I=N_CLOUD_TOP, N_LAYER                                            SLVTRP3A.490   
         DO L=1, N_PROFILE                                                 SLVTRP3A.491   
            FLUX_TOTAL(L, 2*I+1)=FLUX_UP_1(L, I)+FLUX_UP_2(L, I)           SLVTRP3A.492   
     &         +FLUX_UP_3(L, I)                                            SLVTRP3A.493   
            FLUX_TOTAL(L, 2*I+2)=FLUX_DOWN_1(L, I)+FLUX_DOWN_2(L, I)       SLVTRP3A.494   
     &         +FLUX_DOWN_3(L, I)                                          SLVTRP3A.495   
         ENDDO                                                             SLVTRP3A.496   
      ENDDO                                                                SLVTRP3A.497   
!                                                                          SLVTRP3A.498   
!     REDUCE TO NET FLUXES IF REQUIRED.                                    SLVTRP3A.499   
      IF (L_NET) THEN                                                      SLVTRP3A.500   
         DO I=0, N_LAYER                                                   SLVTRP3A.501   
            DO L=1, N_PROFILE                                              SLVTRP3A.502   
               FLUX_TOTAL(L, I+1)                                          SLVTRP3A.503   
     &            =FLUX_TOTAL(L, 2*I+2)-FLUX_TOTAL(L, 2*I+1)               SLVTRP3A.504   
            ENDDO                                                          SLVTRP3A.505   
         ENDDO                                                             SLVTRP3A.506   
      ENDIF                                                                SLVTRP3A.507   
!                                                                          SLVTRP3A.508   
!                                                                          SLVTRP3A.509   
!                                                                          SLVTRP3A.510   
      RETURN                                                               SLVTRP3A.511   
      END                                                                  SLVTRP3A.512   
*ENDIF DEF,A01_3A,OR,DEF,A02_3A                                            SLVTRP3A.513   
*ENDIF DEF,A70_1A                                                          SLVTRP3A.514   
