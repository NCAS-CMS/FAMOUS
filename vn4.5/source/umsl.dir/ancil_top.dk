#! /bin/ksh                                                                ancil_top.2     
# ----------------------------- COPYRIGHT ---------------------------- #   COPYRIGHT.83    
#           (c) BRITISH CROWN COPYRIGHT 2000, THE MET.OFFICE           #   COPYRIGHT.84    
#                                                                      #   COPYRIGHT.85    
# Use, duplication or disclosure of this code is subject to the        #   COPYRIGHT.86    
# restrictions as set forth in the contract. If no contract has been   #   COPYRIGHT.87    
# raised with this copy of the code, use, duplication or disclosure    #   COPYRIGHT.88    
# of it is strictly prohibited. Permission to do so must be obtained   #   COPYRIGHT.89    
# in writing from the Head of Numerical Modelling at The Met. Office.  #   COPYRIGHT.90    
# ----------------------------- COPYRIGHT ---------------------------- #   COPYRIGHT.91    
#LL  Script:  ancil_top_level                                              ancil_top.3     
#LL---------------------------------------------------------------------   ancil_top.4     
#LL                                                                        ancil_top.5     
#LL  Purpose: High level script to create ancillary files.                 ancil_top.6     
#LL                                                                        ancil_top.7     
#LL  Method:  The user executes this script with various options           ancil_top.8     
#LL           specifying what ancillary files are required.  This          ancil_top.9     
#LL           script then calls various lower level scripts to create      ancil_top.10    
#LL           the script that will run the central ancillary program       ancil_top.11    
#LL           which is then submitted to the T3E for execution.            ancil_top.12    
#LL                                                                        ancil_top.13    
#LL  Current Owner:  Clive Jones NWP(DA)                                   ancil_top.14    
#LL  Reviewer: Dave Robinson           Date of review: ????                ancil_top.15    
#LL                                                                        ancil_top.16    
#LL  UM version no: 4.5                                                    ancil_top.17    
#LL                                                                        ancil_top.18    
#LL  History:                                                              ancil_top.19    
#LL  Model                                                                 ancil_top.20    
#LL  version  Date     Modification history:                               ancil_top.21    
#LL  4.5      5/5/98   Original version. Clive Jones.                      ancil_top.22    
#LL                                                                        ancil_top.23    
#LL  Programming standard: UMDP 3                                          ancil_top.24    
#LL                                                                        ancil_top.25    
#LL  External documentation:                                               ancil_top.26    
#LL  UMDP 73 Ancillary File Creation for the UM.                           ancil_top.27    
#LL                                                                        ancil_top.28    
#LL  Called by: user                                                       ancil_top.29    
#LL                                                                        ancil_top.30    
#LL  Calls: ancil_mask                                                     ancil_top.31    
#LL         ancil_orog                                                     ancil_top.32    
#LL         ancil_ozone                                                    ancil_top.33    
#LL         ancil_slt                                                      ancil_top.34    
#LL         ancil_smow                                                     ancil_top.35    
#LL         ancil_sstice                                                   ancil_top.36    
#LL         ancil_vegsoil                                                  ancil_top.37    
#LL                                                                        ancil_top.38    
######################################################################     ancil_top.39    
#                                                                    #     ancil_top.40    
#  Options:                                                          #     ancil_top.41    
#  -l {}                 Land sea mask (default=qrparm.mask in output#     ancil_top.42    
#                        directory or $UMDIR)                        #     ancil_top.43    
#  -k {}                 No. of model levels (Needed for ozone)      #     ancil_top.44    
#  -m {model id}         model identifier (default=cl_9673)          #     ancil_top.45    
#  -n {file}             grid namelist if non standard resolution    #     ancil_top.46    
#  -o {directory name}   Directory for output files (default=        #     ancil_top.47    
#                        $HOME/ancil.vn{version}/model_id            #     ancil_top.48    
#  -p {}                 time limit for CRAY job (default=3000)      #     ancil_top.49    
#  -q {}                 queue for CRAY job (default=prime)          #     ancil_top.50    
#  -y {}                 memory limit for CRAY job (default=9000)    #     ancil_top.51    
#  -r                    do not submit script (this allows for the   #     ancil_top.52    
#                        script to be edited before submission)      #     ancil_top.53    
#  -s {file}             script to create (default=make_ancil_file)  #     ancil_top.54    
#  -t {file}             file for control namelists (default=        #     ancil_top.55    
#                        ancil_namelists                             #     ancil_top.56    
#  -u {version}          UM version number (default=4.5)             #     ancil_top.57    
#  -v                    verbose mode                                #     ancil_top.58    
#  -x {file}             Different executable                        #     ancil_top.59    
#  -z {list}             List of datasets to create                  #     ancil_top.60    
#                        (specify mask orog sstice vegsoil           #     ancil_top.61    
#                         slt smow ozone ozoneli)                    #     ancil_top.62    
# The following arguments are for options in the low level routines. #     ancil_top.63    
# See low level routines for details.                                #     ancil_top.64    
# -a {list}              options for land sea mask                   #     ancil_top.65    
# -b {list}              options for orography                       #     ancil_top.66    
# -c {list}              options for vegetation and soil             #     ancil_top.67    
# -d {list}              options for soil moisture & snow            #     ancil_top.68    
# -e {list}              options for sea surface temperature & seaice#     ancil_top.69    
# -f {list}              options for deep soil temperatures          #     ancil_top.70    
# -g {list}              options for ozone                           #     ancil_top.71    
#                                                                    #     ancil_top.72    
######################################################################     ancil_top.73    
#L End of header -------------------------------------------------------   ancil_top.74    
                                                                           ancil_top.75    
banner ANCILLARY                                                           ancil_top.76    
set -a                                                                     ancil_top.77    
                                                                           ancil_top.78    
echo "Ancillary File Making Procedure Starting"                            ancil_top.79    
                                                                           ancil_top.80    
# set defaults                                                             ancil_top.81    
VN=4.5                                                                     ancil_top.82    
MODEL=cl_9673                                                              ancil_top.83    
                                                                           ancil_top.84    
LSMASK=false                                                               ancil_top.85    
OROG=false                                                                 ancil_top.86    
VEGSOIL=false                                                              ancil_top.87    
SMCSNOW=false                                                              ancil_top.88    
SSTICE=false                                                               ancil_top.89    
DEEPST=false                                                               ancil_top.90    
OZONE=false                                                                ancil_top.91    
OZONE_LI=false                                                             ancil_top.92    
                                                                           ancil_top.93    
VERBOSE=false                                                              ancil_top.94    
                                                                           ancil_top.95    
RUNX=true                                                                  ancil_top.96    
                                                                           ancil_top.97    
# Default for CRAY batch running                                           ancil_top.98    
TIME=3000   # time                                                         ancil_top.99    
MEMORY=90   # memory                                                       ancil_top.100   
QUEUE=prime # queue                                                        ancil_top.101   
                                                                           ancil_top.102   
# get options                                                              ancil_top.103   
                                                                           ancil_top.104   
while getopts a:b:c:d:e:f:g:h:k:l:m:n:o:p:q:rs:t:u:vx:y:z: name            ancil_top.105   
do                                                                         ancil_top.106   
  case $name in                                                            ancil_top.107   
  a)                                                                       ancil_top.108   
    MASKOPTS=$OPTARG;;                                                     ancil_top.109   
  b)                                                                       ancil_top.110   
    OROGOPTS=$OPTARG;;                                                     ancil_top.111   
  c)                                                                       ancil_top.112   
    VEGSOPTS=$OPTARG;;                                                     ancil_top.113   
  d)                                                                       ancil_top.114   
    SMOWOPTS=$OPTARG;;                                                     ancil_top.115   
  e)                                                                       ancil_top.116   
    SSTIOPTS=$OPTARG;;                                                     ancil_top.117   
  f)                                                                       ancil_top.118   
    SLTOPTS=$OPTARG;;                                                      ancil_top.119   
  g)                                                                       ancil_top.120   
    OZOOPTS=$OPTARG;;                                                      ancil_top.121   
  k)                                                                       ancil_top.122   
    NO_LEVELS=$OPTARG;;                                                    ancil_top.123   
  l)                                                                       ancil_top.124   
    MASKIN=$OPTARG;;                                                       ancil_top.125   
  m)                                                                       ancil_top.126   
    MODEL=$OPTARG;;                                                        ancil_top.127   
  n)                                                                       ancil_top.128   
    GRIDNAME=$OPTARG;;                                                     ancil_top.129   
  o)                                                                       ancil_top.130   
    ANCILDIR=$OPTARG;;                                                     ancil_top.131   
  p)                                                                       ancil_top.132   
    TIME=$OPTARG;;                                                         ancil_top.133   
  q)                                                                       ancil_top.134   
    QUEUE=$OPTARG;;                                                        ancil_top.135   
  r)                                                                       ancil_top.136   
    RUNX=false;;                                                           ancil_top.137   
  s)                                                                       ancil_top.138   
    ANCILSCRIPT=$OPTARG;;                                                  ancil_top.139   
  t)                                                                       ancil_top.140   
    NAMECTRL=$OPTARG;;                                                     ancil_top.141   
  u)                                                                       ancil_top.142   
    VN=$OPTARG;;                                                           ancil_top.143   
  v)                                                                       ancil_top.144   
    VERBOSE=true;;                                                         ancil_top.145   
  x)                                                                       ancil_top.146   
    ANCIL_EXEC=$OPTARG;;                                                   ancil_top.147   
  y)                                                                       ancil_top.148   
    MEMORY=$OPTARG;;                                                       ancil_top.149   
  z)                                                                       ancil_top.150   
    DATASETS=$OPTARG;;                                                     ancil_top.151   
  esac                                                                     ancil_top.152   
done                                                                       ancil_top.153   
                                                                           ancil_top.154   
if $VERBOSE                                                                ancil_top.155   
then                                                                       ancil_top.156   
  set -x                                                                   ancil_top.157   
fi                                                                         ancil_top.158   
                                                                           ancil_top.159   
########################################################################   ancil_top.160   
#                                                                      #   ancil_top.161   
# Preliminaries                                                        #   ancil_top.162   
# Set up directory and file names etc                                  #   ancil_top.163   
#                                                                      #   ancil_top.164   
########################################################################   ancil_top.165   
                                                                           ancil_top.166   
# Directory containg ancillary scripts                                     ancil_top.167   
ANCIL_LIB=$UMDIR/vn${VN}/ancil/atmos/scripts/master                        ancil_top.168   
                                                                           ancil_top.169   
# Directory containing standard namelists                                  ancil_top.170   
ANCIL_NAME=$UMDIR/vn${VN}/ancil/atmos/card_input/namelist                  ancil_top.171   
                                                                           ancil_top.172   
# Directory containing changes to standard datasets                        ancil_top.173   
ANCIL_CHANGES=$UMDIR/vn${VN}/ancil/atmos/card_input/changes                ancil_top.174   
                                                                           ancil_top.175   
# Directory containing lookup tables                                       ancil_top.176   
ANCIL_PARMS=$UMDIR/vn${VN}/ancil/atmos/card_input/parm_list                ancil_top.177   
                                                                           ancil_top.178   
# Directory containing master ancillary files                              ancil_top.179   
ANCIL_MASTER=$UMDIR/vn${VN}/ancil/atmos/master                             ancil_top.180   
                                                                           ancil_top.181   
# Central Ancillary Program Executable                                     ancil_top.182   
ANCIL_EXEC=${ANCIL_EXEC:-\$UMDIR/vn${VN}/exec/ancil}                       ancil_top.183   
                                                                           ancil_top.184   
# find out current date and time                                           ancil_top.185   
DATESTAMP=`date`                                                           ancil_top.186   
                                                                           ancil_top.187   
# If output directory not supplied, create default name                    ancil_top.188   
# In either case ensure directory exists - create it if not                ancil_top.189   
                                                                           ancil_top.190   
ANCILDIR=${ANCILDIR:-$HOME/ancil.vn${VN}/$MODEL}                           ancil_top.191   
                                                                           ancil_top.192   
if test ! -d $ANCILDIR                                                     ancil_top.193   
then                                                                       ancil_top.194   
  mkdir -p $ANCILDIR                                                       ancil_top.195   
  echo "$ANCILDIR did not exist - it does now"                             ancil_top.196   
fi                                                                         ancil_top.197   
                                                                           ancil_top.198   
# File name for script that will run to create files                       ancil_top.199   
ANCILSCRIPT=${ANCILSCRIPT:-make_ancil_file}                                ancil_top.200   
ANCILRUNNAME=$ANCILSCRIPT                                                  ancil_top.201   
ANCILSCRIPT=$ANCILDIR/$ANCILSCRIPT                                         ancil_top.202   
                                                                           ancil_top.203   
# File name for control namelists                                          ancil_top.204   
NAMECTRL=${NAMECTRL:-ancil_namelists}                                      ancil_top.205   
NAMECTRL=$ANCILDIR/$NAMECTRL                                               ancil_top.206   
                                                                           ancil_top.207   
# Initilaise script                                                        ancil_top.208   
                                                                           ancil_top.209   
# QSUB information                                                         ancil_top.210   
echo "# QSUB -eo">$ANCILSCRIPT                                             ancil_top.211   
echo "# QSUB -lT $TIME">>$ANCILSCRIPT                                      ancil_top.212   
echo "# QSUB -lM ${MEMORY}Mw">>$ANCILSCRIPT                                ancil_top.213   
echo "# QSUB -q $QUEUE">>$ANCILSCRIPT                                      ancil_top.214   
echo "# QSUB -nr">>$ANCILSCRIPT                                            ancil_top.215   
echo "# QSUB -r $ANCILRUNNAME">>$ANCILSCRIPT                               ancil_top.216   
echo "# QSUB -o ${ANCILDIR}/${ANCILRUNNAME}.out">>$ANCILSCRIPT             ancil_top.217   
echo "# QSUB -J m">>$ANCILSCRIPT                                           ancil_top.218   
echo "# QSUB -mb">>$ANCILSCRIPT                                            ancil_top.219   
echo "# QSUB -me">>$ANCILSCRIPT                                            ancil_top.220   
echo "">>$ANCILSCRIPT                                                      ancil_top.221   
                                                                           ancil_top.222   
# Other info etc.                                                          ancil_top.223   
echo "#! /bin/ksh">>$ANCILSCRIPT                                           ancil_top.224   
echo "set -x">>$ANCILSCRIPT                                                ancil_top.225   
echo "">>$ANCILSCRIPT                                                      ancil_top.226   
echo "#Script to create ancillary files">>$ANCILSCRIPT                     ancil_top.227   
echo "#Generated at $DATESTAMP">>$ANCILSCRIPT                              ancil_top.228   
echo "">>$ANCILSCRIPT                                                      ancil_top.229   
echo "#Use latest programming environment">>$ANCILSCRIPT                   ancil_top.230   
echo ". prg_latest">>$ANCILSCRIPT                                          ancil_top.231   
echo "">>$ANCILSCRIPT                                                      ancil_top.232   
echo "#UM Version Number">>$ANCILSCRIPT                                    ancil_top.233   
echo "VN=$VN">>$ANCILSCRIPT                                                ancil_top.234   
echo "#Model">>$ANCILSCRIPT                                                ancil_top.235   
echo "MODEL=$MODEL">>$ANCILSCRIPT                                          ancil_top.236   
echo "">>$ANCILSCRIPT                                                      ancil_top.237   
echo "cd \$TMPDIR">>$ANCILSCRIPT                                           ancil_top.238   
                                                                           ancil_top.239   
# Set directory and file paths in $ANCILSCRIPT                             ancil_top.240   
echo "#Directory for master ancillary files">>$ANCILSCRIPT                 ancil_top.241   
echo "ANCIL_MASTER=$ANCIL_MASTER">>$ANCILSCRIPT                            ancil_top.242   
echo "">>$ANCILSCRIPT                                                      ancil_top.243   
echo "#Directory for input lookup tables">>$ANCILSCRIPT                    ancil_top.244   
echo "ANCIL_PARMS=$ANCIL_PARMS">>$ANCILSCRIPT                              ancil_top.245   
echo "">>$ANCILSCRIPT                                                      ancil_top.246   
echo "#Directory for changes to created datasets">>$ANCILSCRIPT            ancil_top.247   
echo "ANCIL_CHANGES=$ANCIL_CHANGES">>$ANCILSCRIPT                          ancil_top.248   
echo "">>$ANCILSCRIPT                                                      ancil_top.249   
echo "#Directory for created ancillary files">>$ANCILSCRIPT                ancil_top.250   
echo "ANCILDIR=$ANCILDIR">>$ANCILSCRIPT                                    ancil_top.251   
echo "">>$ANCILSCRIPT                                                      ancil_top.252   
echo "#File containing namelists">>$ANCILSCRIPT                            ancil_top.253   
echo "NAMECTRL=$NAMECTRL">>$ANCILSCRIPT                                    ancil_top.254   
echo "">>$ANCILSCRIPT                                                      ancil_top.255   
                                                                           ancil_top.256   
                                                                           ancil_top.257   
# Find out what datasets are required                                      ancil_top.258   
for i in $DATASETS                                                         ancil_top.259   
do                                                                         ancil_top.260   
  if test $i = "mask"                                                      ancil_top.261   
  then                                                                     ancil_top.262   
    LSMASK=true                                                            ancil_top.263   
  elif test $i = "orog"                                                    ancil_top.264   
  then                                                                     ancil_top.265   
    OROG=true                                                              ancil_top.266   
  elif test $i = "sstice"                                                  ancil_top.267   
  then                                                                     ancil_top.268   
    SSTICE=true                                                            ancil_top.269   
  elif test $i = "vegsoil"                                                 ancil_top.270   
  then                                                                     ancil_top.271   
    VEGSOIL=true                                                           ancil_top.272   
  elif test $i = "slt"                                                     ancil_top.273   
  then                                                                     ancil_top.274   
    DEEPST=true                                                            ancil_top.275   
  elif test $i = "smow"                                                    ancil_top.276   
  then                                                                     ancil_top.277   
    SMCSNOW=true                                                           ancil_top.278   
  elif test $i = "ozone"                                                   ancil_top.279   
  then                                                                     ancil_top.280   
    OZONE=true                                                             ancil_top.281   
  elif test $i = "ozoneli"                                                 ancil_top.282   
  then                                                                     ancil_top.283   
    OZONE_LI=true                                                          ancil_top.284   
  fi                                                                       ancil_top.285   
done                                                                       ancil_top.286   
                                                                           ancil_top.287   
                                                                           ancil_top.288   
########################################################################   ancil_top.289   
#                                                                      #   ancil_top.290   
# Namelists                                                            #   ancil_top.291   
# Set up main control namelists                                        #   ancil_top.292   
#                                                                      #   ancil_top.293   
########################################################################   ancil_top.294   
                                                                           ancil_top.295   
# Check that at least one dataset has been requested.  If so create        ancil_top.296   
# main ANCILL namelist.                                                    ancil_top.297   
                                                                           ancil_top.298   
if $LSMASK || $OROG || $SSTICE || $VEGSOIL || $DEEPST || \                 ancil_top.299   
$SMCSNOW || $OZONE ||  $OZONE_LI                                           ancil_top.300   
then                                                                       ancil_top.301   
                                                                           ancil_top.302   
cat >$NAMECTRL<<eof                                                        ancil_top.303   
 &ANCILL                                                                   ancil_top.304   
  LSMASK=$LSMASK,OROG=$OROG,SSTICE=$SSTICE,VEGSOIL=$VEGSOIL,               ancil_top.305   
  DEEPST=$DEEPST,SMCSNOW=$SMCSNOW,OZONE=$OZONE,OZONE_LI=$OZONE_LI          ancil_top.306   
 &END                                                                      ancil_top.307   
eof                                                                        ancil_top.308   
                                                                           ancil_top.309   
else                                                                       ancil_top.310   
                                                                           ancil_top.311   
echo "ERROR: No ancillary datasets requested"                              ancil_top.312   
exit 100                                                                   ancil_top.313   
                                                                           ancil_top.314   
fi                                                                         ancil_top.315   
                                                                           ancil_top.316   
# Set up GRID namelist.                                                    ancil_top.317   
# Standard grids are held centrally, otherwise one must be supplied        ancil_top.318   
                                                                           ancil_top.319   
GRIDNAME=${GRIDNAME:-$ANCIL_NAME/grids/$MODEL}                             ancil_top.320   
                                                                           ancil_top.321   
if test ! -s $GRIDNAME || test ! -r $GRIDNAME                              ancil_top.322   
then                                                                       ancil_top.323   
  echo "ERROR: Grid Namelist does not exist/not readable/empty"            ancil_top.324   
  exit 100                                                                 ancil_top.325   
else                                                                       ancil_top.326   
  cat $GRIDNAME >>$NAMECTRL                                                ancil_top.327   
fi                                                                         ancil_top.328   
                                                                           ancil_top.329   
# Append packing namelist                                                  ancil_top.330   
cat $ANCIL_NAME/unpacked >>$NAMECTRL                                       ancil_top.331   
                                                                           ancil_top.332   
# Append search namelist                                                   ancil_top.333   
cat $ANCIL_NAME/search >>$NAMECTRL                                         ancil_top.334   
                                                                           ancil_top.335   
########################################################################   ancil_top.336   
#                                                                      #   ancil_top.337   
#  Create Script                                                       #   ancil_top.338   
#  For each required dataset call low level script to assign files,    #   ancil_top.339   
#  namelists and environment variables needed to create file.          #   ancil_top.340   
#                                                                      #   ancil_top.341   
########################################################################   ancil_top.342   
                                                                           ancil_top.343   
# Land Sea Mask                                                            ancil_top.344   
if $LSMASK                                                                 ancil_top.345   
then                                                                       ancil_top.346   
                                                                           ancil_top.347   
  $ANCIL_LIB/ancil_mask $MASKOPTS                                          ancil_top.348   
  CC=$?                                                                    ancil_top.349   
  if test $CC -ne 0                                                        ancil_top.350   
  then                                                                     ancil_top.351   
    echo "Error in land sea mask"                                          ancil_top.352   
    exit $CC                                                               ancil_top.353   
  fi                                                                       ancil_top.354   
                                                                           ancil_top.355   
fi                                                                         ancil_top.356   
                                                                           ancil_top.357   
# Target land sea mask                                                     ancil_top.358   
# Use file supplied as option or                                           ancil_top.359   
# If LSMASK then use mask that has been created                            ancil_top.360   
# Otherwise look for qrparm.mask in $ANCILDIR                              ancil_top.361   
# Otherwise, if standard model, use centrally stored qrparm.mask           ancil_top.362   
# Otherwise terminate with error                                           ancil_top.363   
                                                                           ancil_top.364   
if test $MASKIN                                                            ancil_top.365   
then                                                                       ancil_top.366   
                                                                           ancil_top.367   
  echo "Using user supplied land sea mask"                                 ancil_top.368   
                                                                           ancil_top.369   
else                                                                       ancil_top.370   
                                                                           ancil_top.371   
  if $LSMASK                                                               ancil_top.372   
  then                                                                     ancil_top.373   
    MASKIN=\$MASKOUT                                                       ancil_top.374   
  else                                                                     ancil_top.375   
    if test -s $ANCILDIR/qrparm.mask                                       ancil_top.376   
    then                                                                   ancil_top.377   
      MASKIN=\$ANCILDIR/qrparm.mask                                        ancil_top.378   
    elif test -s $UMDIR/vn${VN}/ancil/atmos/$MODEL/qrparm.mask             ancil_top.379   
    then                                                                   ancil_top.380   
      MASKIN=\$UMDIR/vn\${VN}/ancil/atmos/\$MODEL/qrparm.mask              ancil_top.381   
    else                                                                   ancil_top.382   
      echo "ERROR: Target land sea mask not found"                         ancil_top.383   
      echo "Either create mask within job, specify mask on -z option"      ancil_top.384   
      echo "or create qrparm.mask in $ANCILDIR"                            ancil_top.385   
      exit 100                                                             ancil_top.386   
    fi                                                                     ancil_top.387   
  fi                                                                       ancil_top.388   
fi                                                                         ancil_top.389   
                                                                           ancil_top.390   
echo "#Target land sea mask">>$ANCILSCRIPT                                 ancil_top.391   
echo "export MASKIN=$MASKIN">>$ANCILSCRIPT                                 ancil_top.392   
echo "">>$ANCILSCRIPT                                                      ancil_top.393   
                                                                           ancil_top.394   
# Orography                                                                ancil_top.395   
if $OROG                                                                   ancil_top.396   
then                                                                       ancil_top.397   
                                                                           ancil_top.398   
  $ANCIL_LIB/ancil_orog $OROGOPTS                                          ancil_top.399   
  CC=$?                                                                    ancil_top.400   
  if test $CC -ne 0                                                        ancil_top.401   
  then                                                                     ancil_top.402   
    echo "Error in orography"                                              ancil_top.403   
    exit $CC                                                               ancil_top.404   
  fi                                                                       ancil_top.405   
                                                                           ancil_top.406   
fi                                                                         ancil_top.407   
                                                                           ancil_top.408   
# Vegetation and Soils Parameters                                          ancil_top.409   
if $VEGSOIL                                                                ancil_top.410   
then                                                                       ancil_top.411   
                                                                           ancil_top.412   
  $ANCIL_LIB/ancil_vegsoil $VEGSOPTS                                       ancil_top.413   
  CC=$?                                                                    ancil_top.414   
  if test $CC -ne 0                                                        ancil_top.415   
  then                                                                     ancil_top.416   
    echo "Error in veg_soil"                                               ancil_top.417   
    exit $CC                                                               ancil_top.418   
  fi                                                                       ancil_top.419   
fi                                                                         ancil_top.420   
                                                                           ancil_top.421   
# Sea Surface Temperature and Seaice                                       ancil_top.422   
if $SSTICE                                                                 ancil_top.423   
then                                                                       ancil_top.424   
                                                                           ancil_top.425   
  $ANCIL_LIB/ancil_sstice $SSTIOPTS                                        ancil_top.426   
  CC=$?                                                                    ancil_top.427   
  if test $CC -ne 0                                                        ancil_top.428   
  then                                                                     ancil_top.429   
    echo "Error in sst_ice"                                                ancil_top.430   
    exit $CC                                                               ancil_top.431   
  fi                                                                       ancil_top.432   
fi                                                                         ancil_top.433   
                                                                           ancil_top.434   
# Deep Soil Temperatures                                                   ancil_top.435   
if $DEEPST                                                                 ancil_top.436   
then                                                                       ancil_top.437   
                                                                           ancil_top.438   
  $ANCIL_LIB/ancil_slt $SLTOPTS                                            ancil_top.439   
  CC=$?                                                                    ancil_top.440   
  if test $CC -ne 0                                                        ancil_top.441   
  then                                                                     ancil_top.442   
    echo "Error in deep soil temperatures"                                 ancil_top.443   
    exit $CC                                                               ancil_top.444   
  fi                                                                       ancil_top.445   
fi                                                                         ancil_top.446   
                                                                           ancil_top.447   
# Soil Moisture and Snow Amount                                            ancil_top.448   
if $SMCSNOW                                                                ancil_top.449   
then                                                                       ancil_top.450   
                                                                           ancil_top.451   
  $ANCIL_LIB/ancil_smow $SMOWOPTS                                          ancil_top.452   
  CC=$?                                                                    ancil_top.453   
  if test $CC -ne 0                                                        ancil_top.454   
  then                                                                     ancil_top.455   
    echo "Error in soil moisture and snow amount"                          ancil_top.456   
    exit $CC                                                               ancil_top.457   
  fi                                                                       ancil_top.458   
fi                                                                         ancil_top.459   
                                                                           ancil_top.460   
# Oozne                                                                    ancil_top.461   
if $OZONE || $OZONE_LI                                                     ancil_top.462   
then                                                                       ancil_top.463   
                                                                           ancil_top.464   
  $ANCIL_LIB/ancil_ozone $OZOOPTS -l $NO_LEVELS                            ancil_top.465   
  CC=$?                                                                    ancil_top.466   
  if test $CC -ne 0                                                        ancil_top.467   
  then                                                                     ancil_top.468   
    echo "Error in Ozone"                                                  ancil_top.469   
    exit $CC                                                               ancil_top.470   
  fi                                                                       ancil_top.471   
fi                                                                         ancil_top.472   
                                                                           ancil_top.473   
                                                                           ancil_top.474   
########################################################################   ancil_top.475   
#                                                                      #   ancil_top.476   
#  Executable                                                          #   ancil_top.477   
#                                                                      #   ancil_top.478   
########################################################################   ancil_top.479   
                                                                           ancil_top.480   
# In $ANCILSCRIPT set up executable                                        ancil_top.481   
                                                                           ancil_top.482   
echo "">>$ANCILSCRIPT                                                      ancil_top.483   
echo "#STASHmaster file">>$ANCILSCRIPT                                     ancil_top.484   
echo "export UNIT22=\$UMDIR/vn${VN}/ctldata/STASHmaster">>$ANCILSCRIPT     ancil_top.485   
echo "">>$ANCILSCRIPT                                                      ancil_top.486   
echo "FILENV=\$TMPDIR/main_assign">>$ANCILSCRIPT                           ancil_top.487   
echo "assign -R">>$ANCILSCRIPT                                             ancil_top.488   
echo "assign -f 77 g:sf">>$ANCILSCRIPT                                     ancil_top.489   
echo "">>$ANCILSCRIPT                                                      ancil_top.490   
echo "ls -ls">>$ANCILSCRIPT                                                ancil_top.491   
echo "No. of model levels">>$ANCILSCRIPT                                   ancil_top.492   
echo "export P_LEVELS_ENV=$NO_LEVELS">>$ANCILSCRIPT                        ancil_top.493   
echo "#Central Ancillary Program">>$ANCILSCRIPT                            ancil_top.494   
echo "$ANCIL_EXEC < \$NAMECTRL">>$ANCILSCRIPT                              ancil_top.495   
echo "#Check whether successful">>$ANCILSCRIPT                             ancil_top.496   
echo "CC=\$?">>$ANCILSCRIPT                                                ancil_top.497   
echo "if test \$CC -ne 0">>$ANCILSCRIPT                                    ancil_top.498   
echo "then">>$ANCILSCRIPT                                                  ancil_top.499   
echo "echo \"ERROR: Error in Central Ancillary Program\"">>$ANCILSCRIPT    ancil_top.500   
echo "exit \$CC">>$ANCILSCRIPT                                             ancil_top.501   
echo "fi">>$ANCILSCRIPT                                                    ancil_top.502   
echo "">>$ANCILSCRIPT                                                      ancil_top.503   
echo "#Tidy up links">>$ANCILSCRIPT                                        ancil_top.504   
echo "rm -f fort.*">>$ANCILSCRIPT                                          ancil_top.505   
echo "">>$ANCILSCRIPT                                                      ancil_top.506   
echo "exit \$CC">>$ANCILSCRIPT                                             ancil_top.507   
                                                                           ancil_top.508   
echo "Script Created As Follows"                                           ancil_top.509   
echo "#################################################################"   ancil_top.510   
cat $ANCILSCRIPT                                                           ancil_top.511   
echo "Using Namelist File"                                                 ancil_top.512   
cat $NAMECTRL                                                              ancil_top.513   
echo "#################################################################"   ancil_top.514   
                                                                           ancil_top.515   
                                                                           ancil_top.516   
                                                                           ancil_top.517   
if $RUNX                                                                   ancil_top.518   
then                                                                       ancil_top.519   
########################################################################   ancil_top.520   
#                                                                      #   ancil_top.521   
#  Create Ancillary Files                                              #   ancil_top.522   
#                                                                      #   ancil_top.523   
########################################################################   ancil_top.524   
                                                                           ancil_top.525   
# Submit script that has been created to create required ancillary files   ancil_top.526   
  qsub $ANCILSCRIPT                                                        ancil_top.527   
                                                                           ancil_top.528   
fi                                                                         ancil_top.529   
