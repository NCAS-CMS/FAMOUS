#!/bin/ksh                                                                 COPYRIGHT.822   
# ----------------------------- COPYRIGHT ---------------------------- #   COPYRIGHT.823   
#           (c) BRITISH CROWN COPYRIGHT 2000, THE MET.OFFICE           #   COPYRIGHT.824   
#                                                                      #   COPYRIGHT.825   
# Use, duplication or disclosure of this code is subject to the        #   COPYRIGHT.826   
# restrictions as set forth in the contract. If no contract has been   #   COPYRIGHT.827   
# raised with this copy of the code, use, duplication or disclosure    #   COPYRIGHT.828   
# of it is strictly prohibited. Permission to do so must be obtained   #   COPYRIGHT.829   
# in writing from the Head of Numerical Modelling at The Met. Office.  #   COPYRIGHT.830   
# ----------------------------- COPYRIGHT ---------------------------- #   COPYRIGHT.831   
#LL---------------------------------------------------------------------   qsprelim.2     
#LL  Script:  qsprelim                                                     qsprelim.3     
#LL---------------------------------------------------------------------   qsprelim.4     
#LL                                                                        qsprelim.5     
#LL  Purpose: Performs history file preprocessing and dump setup/          qsprelim.6     
#LL           reconfiguration from initial data, imported data and         qsprelim.7     
#LL           ancillary fields.                                            qsprelim.8     
#LL                                                                        qsprelim.9     
#LL  Author:   T C Johns          Date:           21 February 1990         qsprelim.10    
#LL  Reviewer: M A Smith          Date of review:                          qsprelim.11    
#LL                                                                        qsprelim.12    
#LL  Tested under OS version: UNICOS 6.1.5A                                qsprelim.13    
#LL                                                                        qsprelim.14    
#LL  Code version no: 3.1         Date: 11 February 1993                   qsprelim.15    
#LL                                                                        qsprelim.16    
#LL  Modification History:                                                 qsprelim.17    
#LL    20/04/90  Call combine script operationally if $TYPE=CRUN           qsprelim.18    
#LL          (ie. continuation) is flagged.  A separate if block is        qsprelim.19    
#LL          provided in step 1 for OPERATIONAL models.  All error exits   qsprelim.20    
#LL          should now generate an abort condition at the top-level.      qsprelim.21    
#LL  16/05/90  Environment variable SETUP replaced by TYPE = 'NRUN'.       qsprelim.22    
#LL  26/06/90  Dump reconfiguration program incorporated.                  qsprelim.23    
#LL  21/08/90  PPXREF attached to fort.2 for reconfiguration program.      qsprelim.24    
#LL  03/09/90  OROG attached to fort.96 not 94 for configuration           qsprelim.25    
#LL          program (This error also corrected in vn1.3 prelim script)    qsprelim.26    
#LL  23/10/90  vn1.8: file SSU added to reconfiguration step on unit 29;   qsprelim.27    
#LL          GRIBCODE added to reconfiguration step on unit 18.            qsprelim.28    
#LL          PURGEHIST option added                                        qsprelim.29    
#LL  28/10/90  In-line documentation improved.                             qsprelim.30    
#LL  01/11/90  File RECONTMP added ( -su fort.19 work file )               qsprelim.31    
#LL  08/11/90  Decoding of FTXX filenames altered due to unreliable        qsprelim.32    
#LL            formatting of IBM NAMELISTs.                                qsprelim.33    
#LL  12/11/90  GRIBCODE variable renamed as AGRIB throughout.              qsprelim.34    
#LL  13/11/90  PURGEHIST done under $TYPE != "CRUN" not $TYPE = "NRUN"     qsprelim.35    
#LL  14/11/90  Error return codes changed to E_COND variables              qsprelim.36    
#LL            SSU attached -su                                            qsprelim.37    
#LL  03/12/90  Debug added after reconfiguration failure                   qsprelim.38    
#LL  11/12/90  Export RECONTMP and AINITIAL to be used in reconfig prog    qsprelim.39    
#LL  10/04/91  Export ASTART to be used in reconfig program. (R.A.S)       qsprelim.40    
#LL  17/05/91  Rebuild reconfiguration program if required. (R.A.S)        qsprelim.41    
#LL  12/06/91  Name of reconfiguration program fixed not chosen by user.   qsprelim.42    
#LL  16/07/91  qserror_pickup renamed as qspickup (TCJ)                    qsprelim.43    
#LL   1/08/91  Altered libutil.a to libutil2.2.a for gribcode object       qsprelim.44    
#LL            module. (RAS)                                               qsprelim.45    
#LL  17/09/91  Removed reference to cft77402 compilier as now default.     qsprelim.46    
#LL            Alter order for UTIL effects where grib code object         qsprelim.47    
#LL            modules are taken from. They should come from util2.2       qsprelim.48    
#LL            NOT met.                                                    qsprelim.49    
#LL  18/10/91  Altered so that reconfiguration load module name defined    qsprelim.50    
#LL            in user interface script. (RAS)                             qsprelim.51    
#LL  22/11/91  Altered reconfiguration update to a quick update instead    qsprelim.52    
#LL            of a full update.(RAS)                                      qsprelim.53    
#LL  26/11/91  Added AGRIB SSU OZONE SMCSNOWD DSOILTMP SOILTYPE VEGTYPE    qsprelim.54    
#LL            SSTIN SICEIN CURNTIN MASK SLABHCON OROG to list of          qsprelim.55    
#LL            enviroment variables exported                               qsprelim.56    
#LL   7/01/92  Replaced references to TMPDIR by TEMP (RAS)                 qsprelim.57    
#LL  13/01/92  PPXREF moved unit 1 and PPXREFU added to unit 2 (RAS)       qsprelim.58    
#LL            -su added to PPXREF assign statement.                       qsprelim.59    
#LL  29/01/92  Alter reconfiguration to allow atmosphere and/or ocean      qsprelim.60    
#LL            reconfiguration. Introduced RECONSEGLIB to control          qsprelim.61    
#LL            libraries on the load step if reconfig program recompiled   qsprelim.62    
#LL            Update step for recompile option controlled by              qsprelim.63    
#LL             and changed to normal update. (RAS)                        qsprelim.64    
#LL  21/02/92  Altered to send information from remaking reconfiguration   qsprelim.65    
#LL            program to $OUTPUT                                          qsprelim.66    
#LL   2/03/92  Added PPXREF to list of variables exported.                 qsprelim.67    
#LL   6/03/92  Further alterations to make the ocean reconfiguration       qsprelim.68    
#LL            work.                                                       qsprelim.69    
#LL  29/04/92  Replace ANOMFLUX with FLUXCORR, flux correction file.       qsprelim.70    
#LL   6/07/92  Added ATRACER unit 48 and OTRACER unit 49.                  qsprelim.71    
#LL   3/08/92  Altered recompilation of reconfiguration to use cf77 not    qsprelim.72    
#LL            cft77 and segldr separately                                 qsprelim.73    
#LL   6/11/92  NUPCOMMD replaces update in script.                         qsprelim.74    
#LL  13/11/92  removed -su assigns from script.                            qsprelim.75    
#LL  05/02/93  Use qsmakeexec to recompile qsxrecon                        qsprelim.76    
#LL            Add new environment variables for FORTRAN i/o units.        qsprelim.77    
#LL  11/02/93  Added PERTURB and TRANSP to list of environment variables   qsprelim.78    
#LL  15/07/93  Changed UPDATEOPT to UPDOUTA.                               qsprelim.79    
#LL  01/11/93  Environment variable SOURCES added (unit 110). DLRoberts    qsprelim.80    
#LL  05/09/94  Environment variables USRANCIL,USRMULTI,OUSRANCL,           GRB0U304.10    
#LL            OUSRMULT,MURKFILE added at units 111-114 & 109 RTHBarnes    GRB0U304.11    
#LL  02/11/94  vn3.4  Used LIBPATH for directory path and added LIBNAME    GGH5U401.24    
#LL                   to specify library names. Similarly changed          GGH5U401.25    
#LL                   RECONSEGLIB RECONSEGLIBNAME and added RECONLIBDIR.   GGH5U401.26    
#LL                   Added RECONOPT and EXECOPT. Changed XREF to          GGH5U401.27    
#LL                   EXECXREF.  K Rogers                                  GGH5U401.28    
#LL  02/05/95  vn3.5  FTXX.new file introduced for assignment of           GCP0U305.24    
#LL                   filenames to envirionment variables.                 GCP0U305.25    
#LL  06/07/95  Remove redundant code for $INTERACTIVE call qsAAC_verify    GNF2U400.1     
#LL  13/03/96  vn4.1  Introduce Wave sub-model.  RTHBarnes.                WRB1U401.203   
#LL  14/06/96  vn4.1  Moved setting of EXECXREF to top level SCRIPT        GLW3U401.1     
#LL  21/05/96  Rename env. variable SOURCES to SULPEMIS. Add new           GDR1U401.1     
#LL  22.05.97  4.3    added error checking of return codes in the          GSH8U403.1     
#LL                   section of code which builds a user version of       GSH8U403.2     
#LL                   qxrecon_dump (S Robertson)                           GSH8U403.3     
#LL            env. variables SO2NATEM and CHEMOXID. D. Robinson.          GDR1U401.2     
#LL  28/08/97  vn4.4  *DEF CRAYF90 around assigns.                         GLW2U404.24    
#LL                   Setlabel to make recon use highmem pe's   LCW        GLW2U404.25    
#LL  01.09.97  4.4    Provided facility to include compiler overrides      GLW2U404.26    
#LL                   when remaking reconfiguration.  (S Robertson)        GLW2U404.27    
#LL  17/02/97  vn4.3  Namelist edits and assigns added                     GLW4U403.19    
#LL  19/01/98  4.4    Add tar of recon compile files. K Rogers             GLW1U404.18    
#LL 4.4  08/12/97  Copy thist_keep to thist file if it exists. K Rogers    GKR3U404.3     
#LL  15/09/97  vn4.4  Add ancillary file environment variables for         GBX1U404.1     
#LL                   sulphate loading patterns, surface type initial      GBX1U404.2     
#LL                   fractions, initial vegetation state and vegetation   GBX1U404.3     
#LL                   disturbance.   R.A.Betts                             GBX1U404.4     
#LL  15/03/99  Control use of setlabel on reconfiguration by use of        PXQSPREL.1     
#LL            UM_PE_LABEL (T3E only)                                      PXQSPREL.2     
#LL                                                        P.Burton        PXQSPREL.3     
#LL  29/10/98  4.5   Send output from reconfiguration script               GKR3U405.85    
#LL                  pre-processing and make to output file.               GKR3U405.86    
#LL                  Improve messages to output file.                      GKR3U405.87    
#LL                  K Rogers.                                             GKR3U405.88    
#LL  17/06/98  vn4.5  Add ancillary file environment variable for          GCN1U405.1     
#LL                   surface anthropogenic CO2 emissions. C.D.Jones       GCN1U405.2     
#LL  12/06/98  vn4.5  *DEF CRAYF90 around assigns. A Van der Wal           GAV1U405.1     
#LL  12/05/98  vn4.5  Export all envvars defined by $FTXX generically      ARR5U405.1     
#LL                   instead of explicit references. R.Rawlins            ARR5U405.2     
#LL                                                                        qsprelim.81    
#LL  Programming standard: UM Doc Paper 3A, version 1 (29/10/90)           qsprelim.82    
#LL                                                                        qsprelim.83    
#LL  Project task: C0                                                      qsprelim.84    
#LL                                                                        qsprelim.85    
#LL  Logical components covered: J01                                       qsprelim.86    
#LL                                                                        qsprelim.87    
#LL  External documentation:                                               qsprelim.88    
#LL    UM Doc Paper C0 - The top-level control system                      qsprelim.89    
#LL                                                                        qsprelim.90    
#L   Interface and arguments: ------------------------------------------   qsprelim.91    
#L                                                                         qsprelim.92    
#L   qsprelim run_id                                                       qsprelim.93    
#L                                                                         qsprelim.94    
#L     {run_id} ::= 5 character run identifier                             qsprelim.95    
#L                                                                         qsprelim.96    
#L   -------------------------------------------------------------------   qsprelim.97    
#L                                                                         qsprelim.98    
#L   Called by: qsmaster                                                   qsprelim.99    
#L   Calls    : qssetup script                                             qsprelim.100   
#L              qscombine script                                           qsprelim.101   
#L              qspickup script                                            qsprelim.102   
#L              qsAAC_verify script                                        qsprelim.103   
#L              qsmakeexec script - if qxrecon_dump remade                 qsprelim.104   
#L              qxrecon_dump program                                       qsprelim.105   
#L                                                                         qsprelim.106   
#L   Imports:                                                              qsprelim.107   
#L     SETOPT        - shell options                                       qsprelim.108   
#L     TEMP          - temporary directory name                            qsprelim.109   
#L     TYPE          - run type (NRUN or CRUN)                             qsprelim.110   
#L     OPERATIONAL   - operational flag                                    qsprelim.111   
#L     PURGEHIST     - flag to delete old history file if NRUN             qsprelim.112   
#L     INITHIS          - Initial history filename                         GGH2U305.1     
#L     ICTL          - interim control filename                            qsprelim.114   
#L     HKFILE        - operational housekeeping filename                   qsprelim.115   
#L     THIST         - temporary history filename                          qsprelim.116   
#L     PHIST         - permanent history filename                          qsprelim.117   
#L     IHIST         - interim history filename                            qsprelim.118   
#L     FTXX          - FORTRAN unit cross-reference filename               qsprelim.119   
#L     PPXREFU       - User supplied PP cross-reference file               qsprelim.120   
#L     RECONA        - flag to enable atmosphere reconfiguration           qsprelim.121   
#L     RECONO        - flag to enable ocean reconfiguration                qsprelim.122   
#L     RECONEW       - new reconfiguration excutable                       qsprelim.123   
#L     LOADRECON     - load module for reconfiguration                     qsprelim.124   
#L     RECONCTL      - reconfiguration control filename                    qsprelim.125   
#L     OUTPUT        - printed output filename                             qsprelim.126   
#L     E_NORMAL      - error return code (normal completion)               qsprelim.127   
#L     E_ABORT       - error return code (abort condition)                 qsprelim.128   
#L     UPDATE_RECON  - user updates for reconfiguration                    qsprelim.129   
#L     UPDATE_RECONC - user c code updates for reconfiguration             qsprelim.130   
#L     UPDOUTA       - update output options (atmos)                       qsprelim.131   
#L     UPDOUTO       - update output options (ocean)                       qsprelim.132   
#L     RECONSEGLIB   - object library paths for reconfiguration segldr     GGH5U401.29    
#L                     step                                                GGH5U401.30    
#L     RECONSEGLIBNAME-object library names for reconfiguration segldr     GGH5U401.31    
#L                     step                                                GGH5U401.32    
#L     RECONOPT      - specify compiler options for reconfiguration        gkr6u304.7     
#L     NUPCOMMD      - update or nupdate                                   qsprelim.134   
#L                                                                         qsprelim.135   
#L   Exports:                                                              qsprelim.136   
#L     FILENV        - FORTRAN file environment                            qsprelim.137   
#L     PPXREF        - PP cross-reference file                             qsprelim.138   
#L     AINITIAL      - atmosphere initial dump                             qsprelim.139   
#L     OINITIAL      - ocean initial dump                                  qsprelim.140   
#L     WINITIAL      - wave initial dump                                   WRB1U401.204   
#L     ASTART        - atmosphere start dump                               qsprelim.141   
#L     OSTART        - ocean start dump                                    qsprelim.142   
#L     WSTART        - wave start dump                                     WRB1U401.205   
#L     AGRIB         - GRIBcode imported data (atmos)                      qsprelim.143   
#L     SSU           - SSU imported data                                   qsprelim.144   
#L     RECONTMP      - reconfiguration work file                           qsprelim.145   
#L     OZONE         - ozone                                               qsprelim.146   
#L     SMCSNOWD      - soil moisture/snowdepth                             qsprelim.147   
#L     DSOILTMP      - deep soil temperature                               qsprelim.148   
#L     SOILTYPE      - soil-type dependent fields                          qsprelim.149   
#L     VEGTYPE       - veg-type dependent fields                           qsprelim.150   
#L     SSTIN         - sea surface temperature                             qsprelim.151   
#L     SICEIN        - sea ice fields                                      qsprelim.152   
#L     CANOPYW       - canopy water                                        qsprelim.153   
#L     CURNTIN       - surface currents                                    qsprelim.154   
#L     MASK          - land-sea mask                                       qsprelim.155   
#L     OROG          - orography                                           qsprelim.156   
#L     ATRACER       - Atmosphere tracers                                  qsprelim.157   
#L     OTRACER       - Ocean tracers                                       qsprelim.158   
#L     PERTURB       - Perturbation input file (reconfiguration)           qsprelim.159   
#L     TRANSP        - Input dump containing transplant fields for         qsprelim.160   
#L                     reconfiguration.                                    qsprelim.161   
#L     SULPEMIS       - Single level Sulphur Emissions                     GDR1U401.3     
#L     USRANCIL      - user ancillaries file                               GRB0U304.12    
#L     USRMULTI      - multi-level user ancillaries file                   GRB0U304.13    
#L     OUSRANCL      - ocean user ancillaries file                         GRB0U304.14    
#L     OUSRMULT      - ocean multi-level user ancillaries file             GRB0U304.15    
#L     MURKFILE      - file for murkiness aerosol and source term          GRB0U304.16    
#L  SO2NATEM                                                               GDR1U401.4     
#L  CHEMOXID                                                               GDR1U401.5     
#L     AEROFCG       - ancillary file for sulphate loading patterns        GBX1U404.5     
#L     FRACINIT      - ancillary file for surface type initial fractions   GBX1U404.6     
#L     VEGINIT       - ancillary file for vegetation initial state         GBX1U404.7     
#L     DISTURB       - ancillary file for vegetation disturbed fraction    GBX1U404.8     
#L     CO2EMITS      - ancillary file for CO2 emissions                    GCN1U405.3     
#                                                                          GDR1U401.6     
#L     UNIT02                                                              qsprelim.163   
#L     UNIT18                                                              qsprelim.164   
#L     LIBPATH       - object library paths for executable segldr step     gkr6u304.8     
#L     LIBNAME       - object library names for executable segldr step     gkr6u304.9     
#L     EXECOPT       - extra compile options for making executable         gkr6u304.10    
#L                                                                         qsprelim.165   
#L   Local variables:                                                      qsprelim.166   
#L     CC            - script/executable completion code                   qsprelim.167   
#L     WFIN          - windstress, wind-mixing                             qsprelim.168   
#L     HFLUXIN       - solar and remaining heat flux                       qsprelim.169   
#L     PMEIN         - precipitation-evaporation                           qsprelim.170   
#L     ICEFIN        - rad over ice, snow+sublimation                      qsprelim.171   
#L     AIRTMP        - air temperature                                     qsprelim.172   
#L     SALINITY      - surface salinity                                    qsprelim.173   
#L     FLUXCORR      - heat/salt flux corrections                          qsprelim.174   
#L     SLABHCON      - heat convergence (slab model)                       qsprelim.175   
#L     EXECXREF      - reference file for remaking reconfiguration         gkr6u304.11    
#L     MODULE        - reconfiguration dump name for EXECXREF              gkr6u304.12    
#L     USER_MODS     - location of user fortran mods                       qsprelim.178   
#L     USER_CMODS    - location of user c mods                             qsprelim.179   
#L     USER_UPDATES  - Yes for user mods supplied                          qsprelim.180   
#L     EXECPATH      - location of loadmodule required by qsmakeexec       qsprelim.182   
#L     var           - for loop variable                                   ARR5U405.3     
#L                                                                         qsprelim.183   
#L----------------------------------------------------------------------   qsprelim.184   
#L Step 0 - Set up environment variables                                   qsprelim.185   
#L                                                                         qsprelim.186   
set -$SETOPT                                                               qsprelim.187   
                                                                           qsprelim.188   
RECONTMP=$TEMP/$RUNID.recontmp             # work file for reconfig        qsprelim.189   
>$RECONTMP                                 # precreate with w access       qsprelim.190   
#                                                                          qsprelim.191   
#L explicit export required for qxrecon_dump in portable applications      ARR5U405.4     
#L  (other exports for file names accessed from $FTXX file performed       ARR5U405.5     
#L   after associating physical file names).                               ARR5U405.6     
#                                                                          ARR5U405.7     
export RECONTMP                                                            ARR5U405.8     
                                                                           GBX1U404.10    
#L                                                                         qsprelim.199   
*IF DEF,CRAYF90                                                            GLW4U403.20    
FILENV=$TMPDIR/qsprelim_assign                                             GLW4U403.21    
assign -R qsprelim_assign                                                  GLW2U404.9     
assign -f 77 g:sf                                                          GLW4U403.23    
#                                                                          GLW4U403.24    
*ENDIF                                                                     GLW4U403.25    
#L Step 0.1 - purge old history file                                       qsprelim.200   
#L                                                                         qsprelim.201   
if test $TYPE != "CRUN"                                                    qsprelim.202   
then                                                                       qsprelim.203   
  if $PURGEHIST                                                            qsprelim.204   
  then                                                                     qsprelim.205   
    rm $PHIST 2>/dev/null                                                  qsprelim.206   
  fi                                                                       qsprelim.207   
fi                                                                         qsprelim.208   
#                                                                          qsprelim.209   
#L----------------------------------------------------------------------   qsprelim.210   
#L Step 1 - History and control file processing                            qsprelim.211   
#L                                                                         qsprelim.212   
if test -f $THIST -a $TYPE != 'NRUN'          # THIST existing file        qsprelim.213   
then                                          # (not NRUN operationally)   qsprelim.214   
  if test -s $THIST                         # THIST non-null               qsprelim.215   
  then                                                                     qsprelim.216   
    echo                                                                   qsprelim.217   
    echo "$0: Executing qspickup"                                          qsprelim.218   
    echo                                                                   qsprelim.219   
    qspickup $THIST $PHIST                                                 qsprelim.220   
    CC=$?                                                                  qsprelim.221   
    if test $CC -ne 0                                                      qsprelim.222   
    then                                                                   qsprelim.223   
      echo "$0: Error in qspickup step"                                    qsprelim.224   
      if $OPERATIONAL                                                      qsprelim.225   
      then                                                                 qsprelim.226   
        if test -f $INITHIS                      # INITHIS existing file   GGH2U305.2     
        then                                                               qsprelim.228   
          echo                                                             qsprelim.229   
          echo "$0: Executing setup"                                       qsprelim.230   
          echo                                                             qsprelim.231   
          qssetup $INITHIS $IHIST $FTXX                                    GGH2U305.3     
          CC=$?                                                            qsprelim.233   
          if test $CC -ne 0                                                qsprelim.234   
          then                                                             qsprelim.235   
            echo "$0: Error in setup step"                                 qsprelim.236   
            exit $CC                                                       qsprelim.237   
          fi                                                               qsprelim.238   
        else                                  # INITHIS non-existent       GGH2U305.4     
          echo "$0: Model $1 - Error: no master control file found"        qsprelim.240   
          exit $E_ABORT                                                    qsprelim.241   
        fi                                                                 qsprelim.242   
      else                                                                 qsprelim.243   
        exit $CC                                                           qsprelim.244   
      fi                                                                   qsprelim.245   
    fi                                                                     qsprelim.246   
    rm $THIST                                                              qsprelim.247   
    echo                                                                   qsprelim.248   
    echo "$0: Executing combine"                                           qsprelim.249   
    echo                                                                   qsprelim.250   
    qscombine $PHIST $IHIST $FTXX                                          GCP0U305.27    
    CC=$?                                                                  qsprelim.252   
    if test $CC -ne 0                                                      qsprelim.253   
    then                                                                   qsprelim.254   
      echo "$0: Error in combine step"                                     qsprelim.255   
      if $OPERATIONAL                                                      qsprelim.256   
      then                                                                 qsprelim.257   
        if test -f $INITHIS                      # INITHIS existing file   GGH2U305.5     
        then                                                               qsprelim.259   
          echo                                                             qsprelim.260   
          echo "$0: Executing setup"                                       qsprelim.261   
          echo                                                             qsprelim.262   
          qssetup $INITHIS $IHIST $FTXX                                    GGH2U305.6     
          CC=$?                                                            qsprelim.264   
          if test $CC -ne 0                                                qsprelim.265   
          then                                                             qsprelim.266   
            echo "$0: Error in setup step"                                 qsprelim.267   
            exit $CC                                                       qsprelim.268   
          fi                                                               qsprelim.269   
        else                                  # INITHIS non-existent       GGH2U305.7     
          echo "$0: Model $1 - Error: no master control file found"        qsprelim.271   
          exit $E_ABORT                                                    qsprelim.272   
        fi                                                                 qsprelim.273   
      else                                                                 qsprelim.274   
        exit $CC                                                           qsprelim.275   
      fi                                                                   qsprelim.276   
    fi                                                                     qsprelim.277   
  else                                                                     qsprelim.278   
    echo "$0: Model $1 - Error: empty temporary history file"              qsprelim.279   
    exit $E_ABORT                                                          qsprelim.280   
  fi                                                                       qsprelim.281   
else                                          # THIST non-existent file    qsprelim.282   
  if test -f $PHIST -a $TYPE != 'NRUN'        # PHIST existing file        qsprelim.283   
  then                                        # (not NRUN operationally)   qsprelim.284   
    if test ! -s $PHIST                       # PHIST null                 qsprelim.285   
    then                                                                   qsprelim.286   
      echo "$0: Model $1 - Error: perm hist file empty"                    qsprelim.287   
      exit $E_ABORT                                                        qsprelim.288   
    else                                      # PHIST non-null             qsprelim.289   
      echo                                                                 qsprelim.290   
      echo "$0: Executing combine"                                         qsprelim.291   
      echo                                                                 qsprelim.292   
      qscombine $PHIST $IHIST $FTXX                                        GCP0U305.29    
      CC=$?                                                                qsprelim.294   
      if test $CC -ne 0                                                    qsprelim.295   
      then                                                                 qsprelim.296   
        echo "$0: Error in combine step"                                   qsprelim.297   
        if $OPERATIONAL                                                    qsprelim.298   
        then                                                               qsprelim.299   
          if test -f $INITHIS                    # INITHIS existing file   GGH2U305.8     
          then                                                             qsprelim.301   
            echo                                                           qsprelim.302   
            echo "$0: Executing setup"                                     qsprelim.303   
            echo                                                           qsprelim.304   
            qssetup $INITHIS $IHIST $FTXX                                  GGH2U305.9     
            CC=$?                                                          qsprelim.306   
            if test $CC -ne 0                                              qsprelim.307   
            then                                                           qsprelim.308   
              echo "$0: Error in setup step"                               qsprelim.309   
              exit $CC                                                     qsprelim.310   
            fi                                                             qsprelim.311   
          else                                # INITHIS non-existent       GGH2U305.10    
            echo "$0: Model $1 - Error: no master control file found"      qsprelim.313   
            exit $E_ABORT                                                  qsprelim.314   
          fi                                                               qsprelim.315   
        else                                                               qsprelim.316   
          exit $CC                                                         qsprelim.317   
        fi                                                                 qsprelim.318   
      fi                                                                   qsprelim.319   
    fi                                                                     qsprelim.320   
  else                                        # PHIST non-existent fil     qsprelim.321   
    if test -f $INITHIS                          # INITHIS existing file   GGH2U305.11    
    then                                                                   qsprelim.323   
*IF DEF,CRAYF90                                                            GAV1U405.2     
FILENV=$TMPDIR/qxsetup_assign                                              GKR8U402.23    
assign -R                                                                  GKR8U402.24    
assign -f 77 g:sf                                                          GKR8U402.25    
*ENDIF                                                                     GAV1U405.3     
      echo                                                                 qsprelim.324   
      echo "$0: Executing setup"                                           qsprelim.325   
      echo                                                                 qsprelim.326   
      qssetup $INITHIS $IHIST $FTXX                                        GGH2U305.12    
      CC=$?                                                                qsprelim.328   
      if test $CC -ne 0                                                    qsprelim.329   
      then                                                                 qsprelim.330   
        echo "$0: Error in setup step"                                     qsprelim.331   
        exit $CC                                                           qsprelim.332   
      fi                                                                   qsprelim.333   
    else                                      # INITHIS non-existent       GGH2U305.13    
      echo "$0: Model $1 - Error: no master control file found"            qsprelim.335   
      exit $E_ABORT                                                        qsprelim.336   
    fi                                                                     qsprelim.337   
  fi                                                                       qsprelim.338   
                                                                           GKR3U404.4     
  # Copy back backup version of the thist file if one exists               GKR3U404.5     
  # in case the run fails before the next safe restart point               GKR3U404.6     
  # so that it can go back to the last safe restart point                  GKR3U404.7     
  # rather than the beginning of this run which is not at a                GKR3U404.8     
  # safe restart point.                                                    GKR3U404.9     
  if test $TYPE != 'NRUN'                                                  GKR3U404.10    
  then                                                                     GKR3U404.11    
    if $OPERATIONAL                                                        GKR3U404.12    
    then                                                                   GKR3U404.13    
      :                                                                    GKR3U404.14    
    else                                                                   GKR3U404.15    
      if test -s $THIST1                                                   GKR3U404.16    
      then                                                                 GKR3U404.17    
        mv $THIST1 $THIST                                                  GKR3U404.18    
        CC=$?                                                              GKR3U404.19    
        if test $CC -ne 0                                                  GKR3U404.20    
        then                                                               GKR3U404.21    
          echo "qsprelim: Unable to move $THIST1 to $THIST. Error: $CC"    GKR3U404.22    
        else                                                               GKR3U404.23    
          echo "qsprelim: $THIST1 moved to $THIST"                         GKR3U404.24    
        fi                                                                 GKR3U404.25    
      fi                                                                   GKR3U404.26    
    fi                                                                     GKR3U404.27    
  fi                                                                       GKR3U404.28    
fi                                                                         qsprelim.339   
#                                                                          qsprelim.340   
#L----------------------------------------------------------------------   qsprelim.341   
#L Step 2 - Set up start dump(s) at the requested resolution with          qsprelim.342   
#L         appropriate diagnostic slots reserved, if new run and           qsprelim.343   
#L         initial dump needs to be reconfigured to new resolution or      qsprelim.344   
#L         diagnostic fields                                               qsprelim.345   
#L *** Reconfiguration currently NOT available for Wave sub-model          WRB1U401.207   
                                                                           GSH8U403.4     
if test $TYPE = 'NRUN' -a $RECONW = 'true'                                 GLW2U402.7     
then                                                                       WRB1U401.209   
#L Just copy initial wave dump to start file                               WRB1U401.210   
  cp $WINITIAL $WSTART                                                     WRB1U401.211   
fi                                                                         WRB1U401.212   
#L                                                                         qsprelim.346   
if test $TYPE = 'NRUN'                                                     qsprelim.347   
then                                                                       qsprelim.348   
 if test $RECONA = true -o $RECONO = true                                  GLW2U402.8     
 then                                                                      qsprelim.350   
   if test $RECONEW = true                                                 GSH8U403.5     
   then                                                                    qsprelim.354   
                                                                           GSH4U404.1     
     # Rebuild the reconfiguration with any user mods supplied.            GSH4U404.2     
     echo 'qsprelim: %RECONEW% output from remaking reconfiguration'\      qsprelim.355   
     >> $OUTPUT                                                            qsprelim.356   
                                                                           qsprelim.357   
     # Additional variables                                                GSH4U404.3     
                                                                           qsprelim.359   
     MODULE=qxrecon_dump                 # module name                     qsprelim.361   
     EXECPATH=$LOADRECON                 # loadmodule path                 qsprelim.362   
     LIBPATH=$RECONSEGLIB                # object library path             gkr6u304.14    
     LIBNAME=$RECONSEGLIBNAME            # object library names            gkr6u304.15    
     EXECOPT=$RECONOPT                                                     gkr6u304.16    
     USER_MODS=$UPDATE_RECON                                               qsprelim.364   
     USER_CMODS=$UPDATE_RECONC                                             qsprelim.365   
     USER_UPDATES="YES"                                                    qsprelim.366   
     RECONVARS=${RECONVARS:-$URECONDIR/recon_vars}                         GSH4U404.4     
     RECONVARSOLD=${RECONVARSOLD:-$URECONDIR/recon_vars.old}               GSH4U404.5     
                                                                           GSH8U403.6     
# Extract source code required to create reconfiguration executable        GKR8U402.26    
                                                                           GKR8U402.27    
     mkdir $URECONDIR                                                      GSH8U403.7     
     CC=$?                                                                 GSH8U403.8     
     # report an error if the file could not be created and didn't         GSH8U403.9     
     # already exist                                                       GSH8U403.10    
     if test $CC -ne 0 -a ! -d $URECONDIR                                  GSH8U403.11    
     then                                                                  GSH8U403.12    
       echo qsprelim: Failed to create $URECONDIR                          GSH8U403.13    
       exit $CC                                                            GSH8U403.14    
     fi                                                                    GSH8U403.15    
                                                                           GLW1U404.20    
# Unpack tar file containing reconfiguration compile directory files       GLW1U404.21    
# if necessary                                                             GLW1U404.22    
                                                                           GLW1U404.23    
  if test $SKIP_TAR_COMPDIR != 'true'                                      GLW1U404.24    
  then    # tar file system in use for compile files                       GLW1U404.25    
                                                                           GLW1U404.26    
    if test `ls $URECONDIR/exec_build/qxrecon_dump_dir/*.f \               GLW1U404.27    
                                  2>/dev/null|wc -w`       -eq 0           GLW1U404.28    
    then     # there are no .f files (so no manual user editing)           GLW1U404.29    
                                                                           GLW1U404.30    
      if test -s $RECON_TAR.gz                                             GLW1U404.31    
      then     # zipped tar file exists ie. this is not the initial run    GLW1U404.32    
                                                                           GLW1U404.33    
        gzip -d $RECON_TAR.gz   # unzip tar file                           GLW1U404.34    
                                                                           GLW1U404.35    
        if test $? -eq 0                                                   GLW1U404.36    
        then                                                               GLW1U404.37    
                                                                           GLW1U404.38    
          if test -s $RECON_TAR                                            GLW1U404.39    
          then     # tar file exists ie. this is not the initial run       GLW1U404.40    
                                                                           GLW1U404.41    
            cd $URECONDIR/exec_build/qxrecon_dump_dir                      GLW1U404.42    
            if test $? -eq 0   # successful cd                             GLW1U404.43    
            then                                                           GLW1U404.44    
              tar -xf $RECON_TAR  # unpack compile tar file                GLW1U404.45    
              if test $? -eq 0   # successful untar                        GLW1U404.46    
              then                                                         GLW1U404.47    
                rm $RECON_TAR  # remove tar file                           GLW1U404.48    
              fi                                                           GLW1U404.49    
            fi  # test $? on cd                                            GLW1U404.50    
                                                                           GLW1U404.51    
          fi    # test -s $RECON_TAR                                       GLW1U404.52    
                                                                           GLW1U404.53    
        fi  # test $? -eq 0                                                GLW1U404.54    
                                                                           GLW1U404.55    
      elif test -s $RECON_TAR                                              GLW1U404.56    
      then     # zip file doesn't exist but tar file does                  GLW1U404.57    
                                                                           GLW1U404.58    
        cd $URECONDIR/exec_build/qxrecon_dump_dir                          GLW1U404.59    
        if test $? -eq 0   # successful cd                                 GLW1U404.60    
        then                                                               GLW1U404.61    
          tar -xf $RECON_TAR  # unpack compile tar file                    GLW1U404.62    
          if test $? -eq 0   # successful untar                            GLW1U404.63    
          then                                                             GLW1U404.64    
            rm $RECON_TAR  # remove tar file                               GLW1U404.65    
          fi                                                               GLW1U404.66    
        fi  # test $? on cd                                                GLW1U404.67    
                                                                           GLW1U404.68    
      fi    # test -s $RECON_TAR.gz                                        GLW1U404.69    
                                                                           GLW1U404.70    
    fi      # test `ls -l $URECONDIR/.../*.f>/dev/null` -ne 0              GLW1U404.71    
  fi        # test $SKIP_TAR_COMPDIR != 'true'                             GLW1U404.72    
                                                                           GLW1U404.73    
                                                                           GLW1U404.74    
                                                                           GSH8U403.16    
     if test -s $JOBDIR/RECON_COMP_OPTS                                    GSH4U404.6     
     then                                                                  GSH4U404.7     
                                                                           GKR8U402.29    
       # Compiler overrides have been supplied by the user, create a       GSH4U404.8     
       # recon compile_vars file with these overrides.                     GSH4U404.9     
       rm -f $URECONVARS                                                   GSH4U404.10    
       allcompfiles RECON_COMP_OPTS $JOBDIR $RECONVARS                     GSH4U404.11    
     else                                                                  GSH4U404.12    
                                                                           GSH4U404.13    
       # Use central compile_vars file for recompilation of                GSH4U404.14    
       # reconfiguration.                                                  GSH4U404.15    
       cp $UMDIR/vn$VN/source/compile_vars $RECONVARS                      GSH4U404.16    
     fi                                                                    GSH4U404.17    
                                                                           GSH4U404.18    
     if [[ -f $RECONVARSOLD ]]                                             GSH4U404.19    
     then                                                                  GSH4U404.20    
       # a recon compile_vars file exists from a previous run              GSH4U404.21    
       cmp -s $RECONVARS $RECONVARSOLD                                     GSH4U404.22    
       rel1=$?                                                             GSH4U404.23    
                                                                           GSH4U404.24    
       if test $rel1 -ne 0                                                 GSH4U404.25    
       then                                                                GSH4U404.26    
         # Need to relink, remove reconfiguration executable               GSH4U404.27    
         #                                                                 GSH4U404.28    
         touch  $URECONDIR/exec_build/qxrecon_dump_dir/*.f                 GSH4U404.29    
         rm -rf $URECONDIR/exec_build/qxrecon_dump_dir/$MODULE             GSH4U404.30    
         CC=$?                                                             GSH4U404.31    
         if test $CC -ne 0                                                 GSH4U404.32    
         then                                                              GSH4U404.33    
           echo "qsprelim ($SECONDS): ***\tCannot relink, \                GSH4U404.34    
failed to remove $MODULE executable."                                      GSH4U404.35    
           exit $CC                                                        GSH4U404.36    
         fi                                                                GSH4U404.37    
       fi                                                                  GSH4U404.38    
     fi                                                                    GSH4U404.39    
                                                                           GSH4U404.40    
     # Call qsconf to extract source for reconfiguration with any user     GSH4U404.41    
     # mods and the recon compile_vars file.                               GSH4U404.42    
     qsconf \                                                              GSH4U404.43    
              -outdir $URECONDIR \                                         GSH4U404.44    
              -compvar $RECONVARS \                                        GSH4U404.45    
              -femod $UPDATE_RECON \                                       GSH4U404.46    
              -cemod $UPDATE_RECONC \                                      GSH4U404.47    
	      -execs qxrecon_dump  >> $OUTPUT 2>&1                                GKR3U405.89    
     CC=$?                                                                 qsprelim.368   
                                                                           GSH4U404.48    
     if test $CC -ne 0                                                     qsprelim.369   
     then                                                                  qsprelim.370   
       echo qsprelim: Failed in qsconf extracting code for user \          GKR3U405.90    
	 reconfiguration program.                                                 GKR3U405.91    
       exit $CC                                                            GSH8U403.19    
     fi                                                                    GSH8U403.20    
                                                                           GSH8U403.21    
     cd $URECONDIR/exec_build/qxrecon_dump_dir                             GSH8U403.22    
     CC=$?                                                                 GSH8U403.23    
     if test $CC -ne 0                                                     GSH8U403.24    
     then                                                                  GSH8U403.25    
       echo qsprelim: Failed to move to $URECONDIR/exec_build/\            GSH8U403.26    
qxrecon_dump_dir/                                                          GSH8U403.27    
       exit $CC                                                            GSH8U403.28    
     fi                                                                    GSH8U403.29    
                                                                           GSH8U403.30    
     # Remove zero length files from the reconfiguration                   GSHAU404.4     
     # compile directory                                                   GSHAU404.5     
                                                                           GSHAU404.6     
echo "\nqsprelim($SECONDS): ***\tRemoving zero length files"               GSHAU404.7     
find $URECONDIR/exec_build/qxrecon_dump_dir -size 0 -exec rm {} \;         GSHAU404.8     
echo "qsprelim($SECONDS): ***\tFinished removing files\n"                  GSHAU404.9     
                                                                           GSHAU404.10    
                                                                           GSHAU404.11    
                                                                           GSHAU404.12    
                                                                           GSHAU404.13    
                                                                           GSHAU404.14    
                                                                           GSHAU404.15    
     # run make to build executable                                        GSH8U403.31    
     echo "\nqsprelim: ***\tOutput from reconfiguration make\n" \          GKR3U405.92    
	  >> $OUTPUT                                                              GKR3U405.93    
     make >> $OUTPUT 2>&1                                                  GKR3U405.94    
     CC=$?                                                                 GSH8U403.33    
     if test $CC -ne 0                                                     GSH8U403.34    
     then                                                                  GSH8U403.35    
       echo qsprelim: Failed in make of user reconfiguration program.      GKR3U405.95    
       exit $CC                                                            GSH8U403.37    
     else                                                                  GKR3U405.96    
       echo qsprelim: User reconfiguration program built successfully.     GKR3U405.97    
     fi                                                                    GSH8U403.38    
*IF DEF,MPP                                                                PXQSPREL.4     
      if [[ "$UM_PE_LABEL" != "" ]]                                        PXQSPREL.5     
      then                                                                 PXQSPREL.6     
        setlabel -l $UM_PE_LABEL \                                         PXQSPREL.7     
          $URECONDIR/exec_build/qxrecon_dump_dir/qxrecon_dump              PXQSPREL.8     
      fi                                                                   PXQSPREL.9     
*ENDIF                                                                     PXQSPREL.10    
     cp $URECONDIR/exec_build/qxrecon_dump_dir/qxrecon_dump \              GSH8U403.40    
         $LOADRECON                                                        GSH8U403.41    
     CC=$?                                                                 GSH8U403.42    
     if test $CC -ne 0                                                     GSH8U403.43    
     then                                                                  GSH8U403.44    
       echo qsprelim: Failed to copy $URECONDIR/exec_build/\               GSH8U403.45    
qxrecon_dump_dir/qxrecon_dump $LOADRECON                                   GSH8U403.46    
       exit $CC                                                            qsprelim.371   
     fi                                                                    qsprelim.372   
     # NEED COMMENT                                                        GSH4U404.49    
     mv $RECONVARS $RECONVARSOLD                                           GSH4U404.50    
                                                                           GLW1U404.77    
# Pack all reconfiguration compile directory files into a tar file         GLW1U404.78    
# and remove compile files                                                 GLW1U404.79    
                                                                           GLW1U404.80    
  if test $SKIP_TAR_COMPDIR != 'true'                                      GLW1U404.81    
  then    # tar file system in use for compile files                       GLW1U404.82    
                                                                           GLW1U404.83    
    cd $URECONDIR/exec_build/qxrecon_dump_dir                              GLW1U404.84    
    if test $? -eq 0  # successful cd to compile directory                 GLW1U404.85    
    then                                                                   GLW1U404.86    
      tar -cf $RECON_TAR * # pack compile tar file                         GLW1U404.87    
      if test $? -eq 0              # successful tar                       GLW1U404.88    
      then                                                                 GLW1U404.89    
                                                                           GLW1U404.90    
        gzip $RECON_TAR                                                    GLW1U404.91    
        if test $? -eq 0              # successful gzip                    GLW1U404.92    
        then                                                               GLW1U404.93    
                                                                           GLW1U404.94    
          cd $DATAW                                                        GLW1U404.95    
          rm -r $URECONDIR/exec_build/qxrecon_dump_dir                     GLW1U404.96    
          mkdir $URECONDIR/exec_build/qxrecon_dump_dir                     GLW1U404.97    
                                                                           GLW1U404.98    
          echo "-----------------------------"    >>$COMP_README           GLW1U404.99    
          echo "Reconfiguration compile files"    >>$COMP_README           GLW1U404.100   
          echo "-----------------------------"    >>$COMP_README           GLW1U404.101   
          echo "To unpack tar file:"              >>$COMP_README           GLW1U404.102   
          echo "cd $URECONDIR/exec_build/qxrecon_dump_dir" \               GLW1U404.103   
                          " # compile directory"  >>$COMP_README           GLW1U404.104   
          echo "gzip -d $RECON_TAR.gz # unzip tar file" \                  GLW1U404.105   
                                                  >>$COMP_README           GLW1U404.106   
          echo "tar -xf $RECON_TAR # extract all files" \                  GLW1U404.107   
                                                  >>$COMP_README           GLW1U404.108   
          echo "or"                               >>$COMP_README           GLW1U404.109   
          echo "tar -xf $RECON_TAR reconf1.f" \                            GLW1U404.110   
            " # extract individual file(s)"       >>$COMP_README           GLW1U404.111   
          echo                                    >>$COMP_README           GLW1U404.112   
          echo "To repack tar file:"              >>$COMP_README           GLW1U404.113   
          echo "cd $URECONDIR/exec_build/qxrecon_dump_dir" \               GLW1U404.114   
                            " # compile directory">>$COMP_README           GLW1U404.115   
          echo "tar -cf $RECON_TAR *" \                                    GLW1U404.116   
                   " # tar whole directory"       >>$COMP_README           GLW1U404.117   
          echo "or"                               >>$COMP_README           GLW1U404.118   
          echo "tar -uf $RECON_TAR reconf1.f # update" \                   GLW1U404.119   
            " individual file(s) in tar file"     >>$COMP_README           GLW1U404.120   
          echo "gzip $RECON_TAR # zip tar file"   >>$COMP_README           GLW1U404.121   
          echo "rm * # remove .f, .c files etc"   >>$COMP_README           GLW1U404.122   
          echo                                    >>$COMP_README           GLW1U404.123   
        else                                                               GLW1U404.124   
          rm $RECON_TAR # remove tar file                                  GLW1U404.125   
        fi                                                                 GLW1U404.126   
                                                                           GLW1U404.127   
      else                                                                 GLW1U404.128   
        rm $RECON_TAR  # remove tar file                                   GLW1U404.129   
      fi                                                                   GLW1U404.130   
    fi   # test $? -eq 0  # successful cd to compile directory             GLW1U404.131   
  fi     # test $SKIP_TAR_COMPDIR != 'true'                                GLW1U404.132   
   fi                                                                      qsprelim.373   
#L                                                                         qsprelim.374   
#L Step 2A - Associate physical file names with environment variables      qsprelim.375   
#L          according to the list in FTXX.                                 qsprelim.376   
#L                                                                         qsprelim.377   
# set up file containing env vars by changing ':' to '='                   GCP0U305.32    
sed "s/ *: */=/" $FTXX >$FTXX.new                                          GCP0U305.33    
chmod 755 $FTXX.new                                                        GCP0U305.34    
. $FTXX.new                                                                GCP0U305.35    
#L export all variable names implicitly                                    ARR5U405.9     
echo `cat $FTXX|cut -d: -f1` > $FTXX.vars                                  ARR5U405.10    
for var in `cat $FTXX.vars`                                                ARR5U405.11    
do                                                                         ARR5U405.12    
  export $var                                                              ARR5U405.13    
done                                                                       ARR5U405.14    
#L                                                                         GCP0U305.36    
#L                                                                         qsprelim.460   
#L Step 2B - Set up environment variables for FORTRAN i/o units.           qsprelim.461   
#L                                                                         qsprelim.462   
  UNIT02=$PPXREFU                                                          qsprelim.463   
UNIT22=$STASHMSTR                                                          gss1u401.1     
  UNIT18=$AGRIB                                                            qsprelim.464   
                                                                           qsprelim.465   
# explicit export required by qxrecon_dump                                 qsprelim.466   
                                                                           qsprelim.467   
  export UNIT02 UNIT18                                                     qsprelim.468   
export UNIT22                                                              gss1u401.2     
                                                                           qsprelim.469   
#L                                                                         qsprelim.477   
#L Step 2D - Run the reconfiguration program (logic controlled by file     qsprelim.478   
#L          $RECONCTLA)                                                    qsprelim.479   
#L                                                                         qsprelim.480   
    if test $RECONA = true                                                 GLW2U402.10    
  then                                                                     qsprelim.482   
    echo                                                                   qsprelim.483   
    echo "$0: Executing dump reconfiguration program $LOADRECON"           qsprelim.484   
    echo                                                                   qsprelim.485   
    echo "qsprelim:  %RECONA% Atmosphere reconfiguration step" >>$OUTPUT   PXQSPREL.11    
    echo " " >>$OUTPUT                                                     qsprelim.487   
                                                                           qsprelim.488   
    UNIT05=$RECONCTLA                                                      GLW2U402.11    
    export UNIT05                                                          GLW2U402.12    
                                                                           GLW2U402.13    
*IF DEF,CRAYMPP                                                            GLW2U402.14    
    mpprun -n$RECON_NPROC $LOADRECON <$RECONCTLA >>$OUTPUT                 GLW2U402.15    
*ELSE                                                                      GLW2U402.16    
    $LOADRECON <$RECONCTLA >>$OUTPUT                                       GLW2U402.17    
*ENDIF                                                                     GLW2U402.18    
                                                                           qsprelim.490   
    CC=$?                                                                  qsprelim.491   
    if test $CC -ne 0                                                      qsprelim.492   
    then                                                                   qsprelim.493   
      echo "$0: Error in dump reconfiguration - see OUTPUT"                qsprelim.494   
#      debug -s $LOADRECON -B                                              GKR8U402.46    
#      debugview $LOADRECON core                                           GKR8U402.47    
      exit $CC                                                             qsprelim.496   
    fi                                                                     qsprelim.497   
  fi                                                                       qsprelim.498   
#L                                                                         qsprelim.499   
#L Step 2E - Run the reconfiguration program (logic controlled by file     qsprelim.500   
#L          $RECONCTLO)                                                    qsprelim.501   
#L                                                                         qsprelim.502   
    if test $RECONO = true                                                 GLW2U402.19    
  then                                                                     qsprelim.504   
    echo                                                                   qsprelim.505   
    echo "$0: Executing dump reconfiguration program $LOADRECON"           qsprelim.506   
    echo                                                                   qsprelim.507   
   echo "qsprelim:  %RECONO% Ocean reconfiguration step" >>$OUTPUT         PXQSPREL.12    
    echo " " >>$OUTPUT                                                     qsprelim.509   
                                                                           qsprelim.510   
    UNIT05=$RECONCTLO                                                      GLW2U402.20    
    export UNIT05                                                          GLW2U402.21    
                                                                           GLW2U402.22    
*IF DEF,CRAYMPP                                                            GLW2U402.23    
    mpprun -n$RECON_NPROC $LOADRECON <$RECONCTLO >>$OUTPUT                 GLW2U402.24    
*ELSE                                                                      GLW2U402.25    
    $LOADRECON <$RECONCTLO >>$OUTPUT                                       GLW2U402.26    
*ENDIF                                                                     GLW2U402.27    
                                                                           qsprelim.512   
    CC=$?                                                                  qsprelim.513   
    if test $CC -ne 0                                                      qsprelim.514   
    then                                                                   qsprelim.515   
      echo "$0: Error in dump reconfiguration - see OUTPUT"                qsprelim.516   
#      debug -s $LOADRECON -B                                              GKR8U402.48    
#      debugview $LOADRECON core                                           GKR8U402.49    
      exit $CC                                                             qsprelim.518   
    fi                                                                     qsprelim.519   
  fi                                                                       qsprelim.520   
 fi                                                                        qsprelim.521   
fi                                                                         qsprelim.522   
#                                                                          qsprelim.523   
########################################################################   qsprelim.524   
